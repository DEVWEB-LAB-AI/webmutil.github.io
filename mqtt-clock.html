<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-CAM Viewer - Trang Ch·ªß</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- MQTT.js cho Smart Clock -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <!-- QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <style>
        :root {
            --primary: #4a6fa5;
            --secondary: #166088;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --border: #dee2e6;
            --mqtt-color: #9C27B0;
            --clock-color: #FF9800;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            line-height: 1.6;
        }
        
        /* ================= HEADER & NAVIGATION ================= */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            color: var(--primary);
            font-size: 28px;
        }
        
        .logo-text {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-menu {
            display: flex;
            gap: 15px;
        }
        
        .nav-link {
            text-decoration: none;
            color: var(--gray);
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-link:hover, .nav-link.active {
            color: var(--primary);
            background: rgba(74, 111, 165, 0.1);
        }
        
        /* ================= MAIN LAYOUT ================= */
        .main-layout {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 25px;
        }
        
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
        
        /* ================= VIDEO PANEL (ESP32-CAM) ================= */
        .video-panel {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        
        .video-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .video-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .video-container {
            position: relative;
            background: #000;
            min-height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #videoStream {
            width: 100%;
            max-width: 100%;
            height: auto;
            display: none;
        }
        
        .stream-placeholder {
            text-align: center;
            color: #666;
            padding: 40px;
        }
        
        .stream-placeholder i {
            font-size: 64px;
            margin-bottom: 20px;
            color: var(--gray);
        }
        
        .video-controls {
            padding: 20px;
            background: var(--light);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }
        
        /* ================= CONTROL PANEL ================= */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .panel-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        
        .panel-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-content {
            padding: 25px;
        }
        
        /* ================= SMART CLOCK PANEL ================= */
        .clock-panel {
            border-left: 5px solid var(--clock-color);
        }
        
        .clock-panel .panel-header {
            background: linear-gradient(135deg, var(--clock-color) 0%, #f57c00 100%);
        }
        
        .mqtt-panel {
            border-left: 5px solid var(--mqtt-color);
        }
        
        .mqtt-panel .panel-header {
            background: linear-gradient(135deg, var(--mqtt-color) 0%, #7b1fa2 100%);
        }
        
        /* ================= SMART CLOCK CONTROLS ================= */
        .clock-display {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--clock-color);
            margin: 15px 0;
            font-family: 'Courier New', monospace;
        }
        
        .alarm-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        .time-input {
            width: 70px;
            padding: 12px;
            font-size: 1.3rem;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-weight: bold;
        }
        
        .time-separator {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--clock-color);
        }
        
        .clock-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        /* ================= CAMERA SETTINGS ================= */
        .camera-settings {
            margin: 15px 0;
        }
        
        .slider-group {
            margin-bottom: 15px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .slider-value {
            color: var(--primary);
            font-weight: 600;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        /* ================= MQTT CONNECTION ================= */
        .mqtt-status {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff5252;
        }
        
        .status-dot.connected {
            background: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }
        
        .mqtt-control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* ================= CONNECTION SECTION ================= */
        .connection-section {
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--gray);
        }
        
        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.2);
        }
        
        /* ================= BUTTONS ================= */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 111, 165, 0.3);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .btn-clock {
            background: var(--clock-color);
            color: white;
        }
        
        .btn-mqtt {
            background: var(--mqtt-color);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }
        
        /* ================= STATS ================= */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .stat-card {
            background: var(--light);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* ================= CAMERA LIST ================= */
        .camera-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .camera-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            background: var(--light);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
            transition: all 0.3s ease;
        }
        
        .camera-item:hover {
            background: #e9ecef;
        }
        
        /* ================= MODAL ================= */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body {
            padding: 30px;
            text-align: center;
        }
        
        /* ================= TOAST ================= */
        .toast-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
        }
        
        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(100%);
            opacity: 0;
            animation: slideIn 0.3s ease forwards;
        }
        
        @keyframes slideIn {
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ================= RESPONSIVE ================= */
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                height: auto;
                padding: 15px;
            }
            
            .nav-menu {
                margin-top: 15px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .video-controls {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .clock-buttons {
                grid-template-columns: 1fr;
            }
        }
        
        /* ================= QUICK LINKS ================= */
        .quick-links {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .quick-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: var(--dark);
        }
        
        .quick-link:hover {
            border-color: var(--primary);
            background: rgba(74, 111, 165, 0.05);
            transform: translateY(-3px);
        }
        
        .quick-icon {
            font-size: 20px;
            color: var(--primary);
        }
        
        .quick-text {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }
        
        /* ================= LOADING SPINNER ================= */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header & Navigation -->
    <header class="header">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-video logo-icon"></i>
                <span class="logo-text">ESP32 Control Center</span>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-link active">
                    <i class="fas fa-home"></i>
                    <span>Trang ch·ªß</span>
                </a>
                <a href="camera-dashboard.html" class="nav-link">
                    <i class="fas fa-tv"></i>
                    <span>Dashboard</span>
                </a>
                <a href="espcam.html" class="nav-link">
                    <i class="fas fa-camera"></i>
                    <span>Camera View</span>
                </a>
                <a href="CORS-proxy.html" class="nav-link">
                    <i class="fas fa-link"></i>
                    <span>CORS Proxy</span>
                </a>
            </nav>
        </div>
    </header>
    
    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Left Column: ESP32-CAM Video -->
        <div class="video-panel">
            <div class="video-header">
                <div class="video-title">
                    <i class="fas fa-camera"></i>
                    <h2>ESP32-CAM Live Stream</h2>
                </div>
                <div class="status-indicator" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span>Ch∆∞a k·∫øt n·ªëi</span>
                </div>
            </div>
            
            <div class="video-container" id="videoContainer">
                <img id="videoStream" alt="Live Stream" style="display: none;">
                <div class="stream-placeholder" id="streamPlaceholder">
                    <i class="fas fa-video-slash"></i>
                    <h3>Ch∆∞a c√≥ stream</h3>
                    <p>K·∫øt n·ªëi ƒë·∫øn ESP32-CAM ƒë·ªÉ b·∫Øt ƒë·∫ßu xem</p>
                </div>
                <div class="spinner" id="streamLoading" style="display: none;"></div>
            </div>
            
            <div class="video-controls">
                <button class="btn btn-primary" onclick="startStream()">
                    <i class="fas fa-play"></i>
                    B·∫Øt ƒë·∫ßu stream
                </button>
                <button class="btn btn-danger" onclick="stopStream()">
                    <i class="fas fa-stop"></i>
                    D·ª´ng stream
                </button>
                <button class="btn btn-success" onclick="captureImage()">
                    <i class="fas fa-camera"></i>
                    Ch·ª•p ·∫£nh
                </button>
                <button class="btn btn-warning" id="flashToggle" onclick="toggleFlash()">
                    <i class="fas fa-lightbulb"></i>
                    Flash
                </button>
                <button class="btn btn-info" onclick="takeSnapshot()">
                    <i class="fas fa-download"></i>
                    T·∫£i ·∫£nh
                </button>
                <button class="btn btn-outline" onclick="fullscreen()">
                    <i class="fas fa-expand"></i>
                    To√†n m√†n h√¨nh
                </button>
            </div>
        </div>
        
        <!-- Right Column: Control Panels -->
        <div class="control-panel">
            <!-- Camera Connection Panel -->
            <div class="panel-card">
                <div class="panel-header">
                    <i class="fas fa-camera"></i>
                    Camera Connection
                </div>
                <div class="panel-content">
                    <div class="connection-section">
                        <div class="input-group">
                            <label class="input-label">ƒê·ªãa ch·ªâ IP ESP32-CAM:</label>
                            <input type="text" id="cameraIp" class="input-field" 
                                   placeholder="192.168.1.100 ho·∫∑c esp32-cam.local" 
                                   value="192.168.1.100">
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">Port (m·∫∑c ƒë·ªãnh: 80):</label>
                            <input type="text" id="cameraPort" class="input-field" 
                                   placeholder="80" value="80">
                        </div>
                        
                        <button class="btn btn-primary btn-block" onclick="connectCamera()">
                            <i class="fas fa-plug"></i>
                            K·∫øt n·ªëi ƒë·∫øn Camera
                        </button>
                        
                        <button class="btn btn-outline btn-block" onclick="testCamera()" style="margin-top: 10px;">
                            <i class="fas fa-search"></i>
                            Ki·ªÉm tra k·∫øt n·ªëi
                        </button>
                    </div>
                    
                    <div class="connection-section">
                        <h3 class="section-title">
                            <i class="fas fa-history"></i>
                            Camera ƒë√£ l∆∞u
                        </h3>
                        <div class="camera-list" id="cameraList">
                            <!-- Dynamic content -->
                        </div>
                        <button class="btn btn-outline btn-block" onclick="clearSavedCameras()">
                            <i class="fas fa-trash"></i>
                            X√≥a t·∫•t c·∫£
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Camera Settings Panel -->
            <div class="panel-card">
                <div class="panel-header">
                    <i class="fas fa-sliders-h"></i>
                    Camera Settings
                </div>
                <div class="panel-content">
                    <div class="camera-settings">
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>Ch·∫•t l∆∞·ª£ng (Quality)</span>
                                <span class="slider-value" id="qualityValue">10</span>
                            </div>
                            <input type="range" class="slider" id="qualitySlider" 
                                   min="1" max="63" value="10" oninput="updateQuality()">
                        </div>
                        
                        <div class="slider-group">
                            <div class="slider-label">
                                <span>ƒê·ªô s√°ng (Brightness)</span>
                                <span class="slider-value" id="brightnessValue">0</span>
                            </div>
                            <input type="range" class="slider" id="brightnessSlider" 
                                   min="-2" max="2" value="0" oninput="updateBrightness()">
                        </div>
                        
                        <div class="input-group">
                            <label class="input-label">ƒê·ªô ph√¢n gi·∫£i:</label>
                            <select id="resolutionSelect" class="input-field">
                                <option value="7">QVGA (320x240)</option>
                                <option value="8">CIF (400x296)</option>
                                <option value="9">VGA (640x480)</option>
                                <option value="10" selected>SVGA (800x600)</option>
                                <option value="11">XGA (1024x768)</option>
                                <option value="12">SXGA (1280x1024)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success btn-block" onclick="applySettings()">
                            <i class="fas fa-check"></i>
                            √Åp d·ª•ng c√†i ƒë·∫∑t
                        </button>
                        <button class="btn btn-danger" onclick="rebootCamera()">
                            <i class="fas fa-redo"></i>
                            Reboot
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Smart Clock Panel -->
            <div class="panel-card clock-panel">
                <div class="panel-header">
                    <i class="fas fa-clock"></i>
                    Smart Clock Control
                </div>
                <div class="panel-content">
                    <div class="clock-display" id="currentTimeClock">
                        00:00:00
                    </div>
                    
                    <div class="alarm-controls">
                        <input type="number" class="time-input" id="alarmHour" min="0" max="23" value="7">
                        <span class="time-separator">:</span>
                        <input type="number" class="time-input" id="alarmMinute" min="0" max="59" value="30">
                    </div>
                    
                    <select class="input-field" id="alarmSound" style="margin-bottom: 15px;">
                        <option value="0">üîî Beep</option>
                        <option value="1">üéµ Melody 1</option>
                        <option value="2">üé∂ Melody 2</option>
                    </select>
                    
                    <div class="clock-buttons">
                        <button class="btn btn-success" onclick="setAlarmMQTT(true)">
                            <i class="fas fa-bell"></i>
                            B·∫≠t b√°o th·ª©c
                        </button>
                        <button class="btn btn-danger" onclick="setAlarmMQTT(false)">
                            <i class="fas fa-bell-slash"></i>
                            T·∫Øt b√°o th·ª©c
                        </button>
                        <button class="btn btn-clock" onclick="snoozeAlarmMQTT()">
                            <i class="fas fa-pause"></i>
                            T·∫°m d·ª´ng
                        </button>
                        <button class="btn btn-warning" onclick="resetESP32MQTT()">
                            <i class="fas fa-redo"></i>
                            Kh·ªüi ƒë·ªông l·∫°i
                        </button>
                    </div>
                    
                    <div id="alarmStatus" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; text-align: center; font-weight: bold; color: #666;">
                        Tr·∫°ng th√°i b√°o th·ª©c: Ch∆∞a k·∫øt n·ªëi
                    </div>
                </div>
            </div>
            
            <!-- MQTT Connection Panel -->
            <div class="panel-card mqtt-panel">
                <div class="panel-header">
                    <i class="fas fa-wifi"></i>
                    MQTT Connection
                </div>
                <div class="panel-content">
                    <div class="mqtt-status">
                        <div class="status-dot" id="mqttStatusDot"></div>
                        <span id="mqttStatusText">Ch∆∞a k·∫øt n·ªëi MQTT</span>
                    </div>
                    
                    <div class="input-group">
                        <label class="input-label">MQTT Broker:</label>
                        <input type="text" id="mqttBroker" class="input-field" 
                               value="wss://broker.emqx.io:8084/mqtt">
                    </div>
                    
                    <div class="mqtt-control-buttons">
                        <button class="btn btn-mqtt btn-small" onclick="connectMQTT()" id="connectBtn">
                            <i class="fas fa-plug"></i>
                            K·∫øt n·ªëi MQTT
                        </button>
                        <button class="btn btn-outline btn-small" onclick="disconnectMQTT()" id="disconnectBtn" style="display: none;">
                            <i class="fas fa-unplug"></i>
                            Ng·∫Øt k·∫øt n·ªëi
                        </button>
                        <button class="btn btn-info btn-small" onclick="testMQTT()">
                            <i class="fas fa-broadcast-tower"></i>
                            Test
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 12px; color: #666;">
                        <p><strong>Client ID:</strong> <span id="clientId">web_xxxx</span></p>
                        <p><i class="fas fa-info-circle"></i> Broker m·∫∑c ƒë·ªãnh: EMQX Public MQTT</p>
                    </div>
                </div>
            </div>
            
            <!-- System Stats Panel -->
            <div class="panel-card">
                <div class="panel-header">
                    <i class="fas fa-chart-bar"></i>
                    System Statistics
                </div>
                <div class="panel-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statFps">0</div>
                            <div class="stat-label">FPS</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statLatency">-</div>
                            <div class="stat-label">ƒê·ªô tr·ªÖ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statHeap">-</div>
                            <div class="stat-label">B·ªô nh·ªõ tr·ªëng</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statUptime">0</div>
                            <div class="stat-label">Uptime (s)</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-info btn-block" onclick="requestStatusUpdate()">
                            <i class="fas fa-sync-alt"></i>
                            C·∫≠p nh·∫≠t tr·∫°ng th√°i
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Quick Links Panel -->
            <div class="panel-card">
                <div class="panel-header">
                    <i class="fas fa-bolt"></i>
                    Quick Links
                </div>
                <div class="panel-content">
                    <div class="quick-links">
                        <a href="espcam.html" class="quick-link">
                            <i class="fas fa-camera quick-icon"></i>
                            <span class="quick-text">Full Camera View</span>
                        </a>
                        <a href="mqtt-clock.html" class="quick-link">
                            <i class="fas fa-clock quick-icon"></i>
                            <span class="quick-text">Full Smart Clock</span>
                        </a>
                        <a href="CORS-proxy.html" class="quick-link">
                            <i class="fas fa-link quick-icon"></i>
                            <span class="quick-text">CORS Proxy</span>
                        </a>
                        <a href="#" class="quick-link" onclick="showQRCode()">
                            <i class="fas fa-qrcode quick-icon"></i>
                            <span class="quick-text">QR Code</span>
                        </a>
                        <a href="#" class="quick-link" onclick="sharePage()">
                            <i class="fas fa-share-alt quick-icon"></i>
                            <span class="quick-text">Chia s·∫ª</span>
                        </a>
                        <a href="#" class="quick-link" onclick="fullscreen()">
                            <i class="fas fa-expand quick-icon"></i>
                            <span class="quick-text">Fullscreen</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- QR Code Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-qrcode"></i> QR Code</h3>
                <button onclick="closeModal('qrModal')" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <canvas id="qrCanvas" width="300" height="300"></canvas>
                <p style="margin-top: 20px;">Qu√©t QR code ƒë·ªÉ k·∫øt n·ªëi</p>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- JavaScript -->
    <script>
        // ================= CONFIGURATION =================
        const APP_CONFIG = {
            version: '3.1.0',
            localStorageKeys: {
                cameraHistory: 'esp32cam_history',
                settings: 'esp32cam_settings',
                lastCamera: 'esp32cam_last_camera'
            },
            defaultSettings: {
                quality: 10,
                brightness: 0,
                framesize: 10,
                autoConnect: true
            },
            // API endpoints theo chu·∫©n ESP32-CAM
            apiEndpoints: {
                stream: '/stream',
                capture: '/capture',
                status: '/status',
                control: '/control',
                reboot: '/reboot'
            }
        };
        
        // ================= STATE MANAGEMENT =================
        let state = {
            // ESP32-CAM State
            currentCamera: null,
            isCameraConnected: false,
            isStreaming: false,
            cameraList: [],
            settings: {},
            isFlashOn: false,
            
            // MQTT State
            mqttClient: null,
            isMQTTConnected: false,
            clientId: '',
            
            // Statistics
            fps: 0,
            latency: 0,
            frameCount: 0,
            lastFpsUpdate: 0,
            statsInterval: null
        };
        
        // ================= INITIALIZATION =================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ESP32 Control Center v' + APP_CONFIG.version + ' loaded');
            
            // Generate client ID
            state.clientId = 'web_' + Math.random().toString(16).substr(2, 8);
            document.getElementById('clientId').textContent = state.clientId;
            
            // Load settings
            loadSettings();
            
            // Load camera history
            loadCameraHistory();
            
            // Update clock
            updateClock();
            setInterval(updateClock, 1000);
            
            // Check for URL parameters
            checkUrlParams();
            
            // Setup video event listeners
            const videoElement = document.getElementById('videoStream');
            videoElement.onload = () => {
                document.getElementById('streamLoading').style.display = 'none';
                updateFPS();
            };
            
            videoElement.onerror = () => {
                document.getElementById('streamLoading').style.display = 'none';
                showToast('L·ªói khi t·∫£i stream', 'error');
            };
        });
        
        // ================= URL PARAMETER HANDLING =================
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const cameraIp = urlParams.get('camera');
            
            if (cameraIp) {
                document.getElementById('cameraIp').value = cameraIp;
                setTimeout(() => {
                    connectCamera();
                }, 1000);
            }
            
            const autoConnect = urlParams.get('autoconnect');
            if (autoConnect === 'true' || autoConnect === '1') {
                setTimeout(() => {
                    connectCamera();
                }, 2000);
            }
        }
        
        // ================= ESP32-CAM FUNCTIONS =================
        function connectCamera() {
            const ip = document.getElementById('cameraIp').value.trim();
            const port = document.getElementById('cameraPort').value.trim() || '80';
            
            if (!ip) {
                showToast('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ IP ESP32-CAM', 'warning');
                return;
            }
            
            // Determine camera URL
            let cameraUrl;
            if (ip.includes('.local')) {
                cameraUrl = `http://${ip}`;
            } else {
                cameraUrl = `http://${ip}:${port}`;
            }
            
            connectToCamera(cameraUrl);
        }
        
        async function connectToCamera(cameraUrl) {
            showToast('ƒêang k·∫øt n·ªëi ƒë·∫øn camera...', 'info');
            updateConnectionStatus(false);
            document.getElementById('streamLoading').style.display = 'block';
            
            try {
                // Test connection to status endpoint
                const testUrl = `${cameraUrl}${APP_CONFIG.apiEndpoints.status}`;
                const response = await fetchWithTimeout(testUrl, { timeout: 8000 });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Save to history
                saveCameraToHistory(cameraUrl, data.camera_name || 'ESP32-CAM');
                
                // Update state
                state.currentCamera = cameraUrl;
                state.isCameraConnected = true;
                
                // Update UI
                updateCameraInfo(data);
                updateConnectionStatus(true);
                document.getElementById('streamLoading').style.display = 'none';
                
                // Start stream automatically
                setTimeout(() => {
                    if (state.isCameraConnected) {
                        startStream();
                    }
                }, 500);
                
                showToast(`‚úÖ ƒê√£ k·∫øt n·ªëi ƒë·∫øn ${data.camera_name || 'ESP32-CAM'}`, 'success');
                
            } catch (error) {
                console.error('Connection failed:', error);
                document.getElementById('streamLoading').style.display = 'none';
                
                // Try stream directly if status fails
                showToast('ƒêang th·ª≠ k·∫øt n·ªëi stream tr·ª±c ti·∫øp...', 'warning');
                setTimeout(() => {
                    testStreamConnection(cameraUrl);
                }, 1000);
            }
        }
        
        function testStreamConnection(cameraUrl) {
            const streamUrl = `${cameraUrl}${APP_CONFIG.apiEndpoints.stream}?t=${Date.now()}`;
            const testImg = new Image();
            
            testImg.onload = function() {
                // Stream works, save camera
                saveCameraToHistory(cameraUrl, 'ESP32-CAM (Stream Only)');
                state.currentCamera = cameraUrl;
                state.isCameraConnected = true;
                updateConnectionStatus(true);
                document.getElementById('streamLoading').style.display = 'none';
                showToast('‚úÖ K·∫øt n·ªëi stream th√†nh c√¥ng', 'success');
                
                // Start stream
                setTimeout(startStream, 500);
            };
            
            testImg.onerror = function() {
                updateConnectionStatus(false);
                document.getElementById('streamLoading').style.display = 'none';
                showToast('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn camera', 'error');
            };
            
            testImg.src = streamUrl;
        }
        
        async function testCamera() {
            const ip = document.getElementById('cameraIp').value.trim();
            const port = document.getElementById('cameraPort').value.trim() || '80';
            
            if (!ip) {
                showToast('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ IP', 'warning');
                return;
            }
            
            const cameraUrl = ip.includes('.local') ? `http://${ip}` : `http://${ip}:${port}`;
            showToast('ƒêang ki·ªÉm tra k·∫øt n·ªëi...', 'info');
            
            try {
                const testUrl = `${cameraUrl}${APP_CONFIG.apiEndpoints.status}`;
                const response = await fetchWithTimeout(testUrl, { timeout: 5000 });
                
                if (response.ok) {
                    const data = await response.json();
                    showToast(`‚úÖ Camera ho·∫°t ƒë·ªông: ${data.camera_name || 'ESP32-CAM'}`, 'success');
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showToast(`‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi: ${error.message}`, 'error');
                return false;
            }
        }
        
        function startStream() {
            if (!state.currentCamera || state.isStreaming) return;
            
            stopStream(); // Stop existing stream
            
            const streamUrl = `${state.currentCamera}${APP_CONFIG.apiEndpoints.stream}?t=${Date.now()}`;
            const videoElement = document.getElementById('videoStream');
            const placeholder = document.getElementById('streamPlaceholder');
            
            videoElement.style.display = 'block';
            placeholder.style.display = 'none';
            videoElement.src = streamUrl;
            
            state.isStreaming = true;
            state.lastFpsUpdate = Date.now();
            
            // Start FPS counter
            startFPSCounter();
            
            showToast('‚ñ∂Ô∏è ƒê√£ b·∫Øt ƒë·∫ßu stream', 'success');
        }
        
        function stopStream() {
            const videoElement = document.getElementById('videoStream');
            const placeholder = document.getElementById('streamPlaceholder');
            
            videoElement.src = '';
            videoElement.style.display = 'none';
            placeholder.style.display = 'flex';
            
            state.isStreaming = false;
            state.frameCount = 0;
            
            showToast('‚èπÔ∏è ƒê√£ d·ª´ng stream', 'info');
        }
        
        async function captureImage() {
            if (!state.currentCamera) {
                showToast('Ch∆∞a k·∫øt n·ªëi camera', 'warning');
                return;
            }
            
            try {
                showToast('ƒêang ch·ª•p ·∫£nh...', 'info');
                const captureUrl = `${state.currentCamera}${APP_CONFIG.apiEndpoints.capture}?_=${Date.now()}`;
                const response = await fetch(captureUrl);
                
                if (!response.ok) {
                    throw new Error('Capture failed');
                }
                
                const blob = await response.blob();
                const imageUrl = URL.createObjectURL(blob);
                
                // Create download link
                const link = document.createElement('a');
                link.href = imageUrl;
                link.download = `esp32-capture-${new Date().toISOString().replace(/[:.]/g, '-')}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up
                setTimeout(() => URL.revokeObjectURL(imageUrl), 1000);
                
                showToast('‚úÖ ƒê√£ t·∫£i ·∫£nh xu·ªëng', 'success');
            } catch (error) {
                console.error('Capture error:', error);
                showToast('‚ùå L·ªói khi ch·ª•p ·∫£nh', 'error');
            }
        }
        
        function takeSnapshot() {
            if (!state.isStreaming) {
                showToast('Stream ch∆∞a b·∫≠t', 'warning');
                return;
            }
            
            const videoElement = document.getElementById('videoStream');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = videoElement.videoWidth || 800;
            canvas.height = videoElement.videoHeight || 600;
            
            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            
            const link = document.createElement('a');
            link.download = `snapshot-${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
            
            showToast('üì∏ ƒê√£ ch·ª•p snapshot t·ª´ stream', 'success');
        }
        
        async function toggleFlash() {
            if (!state.currentCamera) return;
            
            state.isFlashOn = !state.isFlashOn;
            const flashValue = state.isFlashOn ? '1' : '0';
            
            try {
                const response = await fetch(`${state.currentCamera}${APP_CONFIG.apiEndpoints.control}?flash=${flashValue}`);
                const data = await response.json();
                
                const flashBtn = document.getElementById('flashToggle');
                if (state.isFlashOn) {
                    flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Flash ON';
                    flashBtn.classList.add('active');
                    showToast('üí° Flash ON', 'success');
                } else {
                    flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Flash';
                    flashBtn.classList.remove('active');
                    showToast('üí° Flash OFF', 'info');
                }
            } catch (error) {
                showToast('‚ùå L·ªói ƒëi·ªÅu khi·ªÉn flash', 'error');
            }
        }
        
        function updateQuality() {
            const value = document.getElementById('qualitySlider').value;
            document.getElementById('qualityValue').textContent = value;
            state.settings.quality = parseInt(value);
        }
        
        function updateBrightness() {
            const value = document.getElementById('brightnessSlider').value;
            document.getElementById('brightnessValue').textContent = value;
            state.settings.brightness = parseInt(value);
        }
        
        async function applySettings() {
            if (!state.currentCamera) {
                showToast('Ch∆∞a k·∫øt n·ªëi camera', 'warning');
                return;
            }
            
            const quality = state.settings.quality || 10;
            const brightness = state.settings.brightness || 0;
            const framesize = document.getElementById('resolutionSelect').value || '10';
            
            try {
                showToast('ƒêang √°p d·ª•ng c√†i ƒë·∫∑t...', 'info');
                
                const params = new URLSearchParams({
                    quality: quality,
                    brightness: brightness,
                    framesize: framesize
                });
                
                const response = await fetch(`${state.currentCamera}${APP_CONFIG.apiEndpoints.control}?${params}`);
                const data = await response.json();
                
                // Save settings
                saveSettings();
                
                showToast('‚úÖ ƒê√£ √°p d·ª•ng c√†i ƒë·∫∑t', 'success');
                
                // Restart stream to apply changes
                if (state.isStreaming) {
                    setTimeout(() => {
                        stopStream();
                        setTimeout(startStream, 1000);
                    }, 500);
                }
                
            } catch (error) {
                console.error('Settings error:', error);
                showToast('‚ùå L·ªói √°p d·ª•ng c√†i ƒë·∫∑t', 'error');
            }
        }
        
        async function rebootCamera() {
            if (!state.currentCamera || !confirm('Kh·ªüi ƒë·ªông l·∫°i camera? Camera s·∫Ω m·∫•t k·∫øt n·ªëi 10-15 gi√¢y.')) {
                return;
            }
            
            try {
                const response = await fetch(`${state.currentCamera}${APP_CONFIG.apiEndpoints.reboot}`);
                if (response.ok) {
                    showToast('üîÑ Camera ƒëang kh·ªüi ƒë·ªông l·∫°i...', 'warning');
                    updateConnectionStatus(false);
                    stopStream();
                    
                    // Try to reconnect after 15 seconds
                    setTimeout(() => {
                        connectToCamera(state.currentCamera);
                    }, 15000);
                }
            } catch (error) {
                showToast('‚ùå L·ªói kh·ªüi ƒë·ªông l·∫°i', 'error');
            }
        }
        
        function fullscreen() {
            const videoContainer = document.getElementById('videoContainer');
            if (!document.fullscreenElement) {
                if (videoContainer.requestFullscreen) {
                    videoContainer.requestFullscreen();
                } else if (videoContainer.webkitRequestFullscreen) {
                    videoContainer.webkitRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }
        }
        
        // ================= MQTT FUNCTIONS =================
        function connectMQTT() {
            if (state.mqttClient && state.isMQTTConnected) {
                showToast('‚úÖ ƒê√£ k·∫øt n·ªëi MQTT r·ªìi!', 'success');
                return;
            }
            
            updateMQTTStatus('ƒêang k·∫øt n·ªëi...', false);
            
            const broker = document.getElementById('mqttBroker').value.trim() || 
                          'wss://broker.emqx.io:8084/mqtt';
            
            const options = {
                clean: true,
                connectTimeout: 4000,
                clientId: state.clientId,
                username: 'emqx',     // Public broker credentials
                password: 'public'
            };
            
            try {
                state.mqttClient = mqtt.connect(broker, options);
                
                state.mqttClient.on('connect', () => {
                    state.isMQTTConnected = true;
                    updateMQTTStatus('ƒê√£ k·∫øt n·ªëi', true);
                    
                    // Subscribe to topics
                    subscribeToTopics();
                    
                    // Update UI
                    document.getElementById('connectBtn').style.display = 'none';
                    document.getElementById('disconnectBtn').style.display = 'block';
                    
                    showToast('‚úÖ ƒê√£ k·∫øt n·ªëi MQTT th√†nh c√¥ng!', 'success');
                });
                
                state.mqttClient.on('message', (topic, message) => {
                    handleMQTTMessage(topic, message.toString());
                });
                
                state.mqttClient.on('error', (error) => {
                    console.error('MQTT Error:', error);
                    updateMQTTStatus('L·ªói k·∫øt n·ªëi', false);
                    showToast('‚ùå L·ªói MQTT: ' + error.message, 'error');
                });
                
                state.mqttClient.on('close', () => {
                    state.isMQTTConnected = false;
                    updateMQTTStatus('M·∫•t k·∫øt n·ªëi', false);
                    document.getElementById('connectBtn').style.display = 'block';
                    document.getElementById('disconnectBtn').style.display = 'none';
                });
                
            } catch (error) {
                showToast('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi MQTT', 'error');
                updateMQTTStatus('K·∫øt n·ªëi th·∫•t b·∫°i', false);
            }
        }
        
        function disconnectMQTT() {
            if (state.mqttClient) {
                state.mqttClient.end();
                state.mqttClient = null;
                state.isMQTTConnected = false;
                updateMQTTStatus('ƒê√£ ng·∫Øt k·∫øt n·ªëi', false);
                
                document.getElementById('connectBtn').style.display = 'block';
                document.getElementById('disconnectBtn').style.display = 'none';
                
                showToast('‚úã ƒê√£ ng·∫Øt k·∫øt n·ªëi MQTT', 'info');
            }
        }
        
        function subscribeToTopics() {
            if (!state.mqttClient || !state.isMQTTConnected) return;
            
            const topics = [
                'smartclock/command',
                'smartclock/status',
                'smartclock/alarm',
                'smartclock/sensors'
            ];
            
            topics.forEach(topic => {
                state.mqttClient.subscribe(topic, (err) => {
                    if (!err) {
                        console.log(`‚úÖ Subscribed to ${topic}`);
                    }
                });
            });
        }
        
        function handleMQTTMessage(topic, message) {
            try {
                const data = JSON.parse(message);
                
                if (topic === 'smartclock/alarm') {
                    // Update alarm status
                    const statusDiv = document.getElementById('alarmStatus');
                    if (data.enabled) {
                        statusDiv.innerHTML = `üîî B√°o th·ª©c: <span style="color: #4CAF50;">ƒêANG B·∫¨T</span> ${data.hour}:${data.minute}`;
                        statusDiv.style.background = '#d4edda';
                    } else {
                        statusDiv.innerHTML = `üîï B√°o th·ª©c: <span style="color: #666;">ƒêANG T·∫ÆT</span>`;
                        statusDiv.style.background = '#f8f9fa';
                    }
                    
                    // Update time inputs
                    if (data.hour !== undefined) {
                        document.getElementById('alarmHour').value = data.hour;
                    }
                    if (data.minute !== undefined) {
                        document.getElementById('alarmMinute').value = data.minute;
                    }
                }
                
            } catch (error) {
                console.error('Error parsing MQTT message:', error);
            }
        }
        
        function sendMQTTCommand(command, data = {}) {
            if (!state.mqttClient || !state.isMQTTConnected) {
                showToast('‚ùå Ch∆∞a k·∫øt n·ªëi MQTT!', 'error');
                return false;
            }
            
            const message = {
                command: command,
                data: data,
                timestamp: Date.now(),
                source: 'web_control'
            };
            
            try {
                state.mqttClient.publish('smartclock/command', JSON.stringify(message));
                console.log(`üì§ Sent MQTT command: ${command}`, data);
                return true;
            } catch (error) {
                showToast('‚ùå L·ªói khi g·ª≠i l·ªánh MQTT', 'error');
                return false;
            }
        }
        
        // Smart Clock Commands
        function setAlarmMQTT(enable) {
            const hour = parseInt(document.getElementById('alarmHour').value);
            const minute = parseInt(document.getElementById('alarmMinute').value);
            const sound = parseInt(document.getElementById('alarmSound').value);
            
            if (hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                showToast('Th·ªùi gian kh√¥ng h·ª£p l·ªá', 'error');
                return;
            }
            
            const success = sendMQTTCommand('setAlarm', {
                hour: hour,
                minute: minute,
                sound: sound,
                enable: enable ? 1 : 0
            });
            
            if (success) {
                showToast(enable ? '‚úÖ ƒê√£ b·∫≠t b√°o th·ª©c!' : '‚ùå ƒê√£ t·∫Øt b√°o th·ª©c!', 'success');
            }
        }
        
        function snoozeAlarmMQTT() {
            const success = sendMQTTCommand('snooze', {});
            if (success) {
                showToast('‚è∏Ô∏è ƒê√£ t·∫°m d·ª´ng b√°o th·ª©c', 'info');
            }
        }
        
        function resetESP32MQTT() {
            if (confirm('Kh·ªüi ƒë·ªông l·∫°i ESP32? Thi·∫øt b·ªã s·∫Ω m·∫•t k·∫øt n·ªëi v√†i gi√¢y.')) {
                const success = sendMQTTCommand('reset', {});
                if (success) {
                    showToast('üîÑ ƒêang kh·ªüi ƒë·ªông l·∫°i ESP32...', 'info');
                }
            }
        }
        
        function testMQTT() {
            if (!state.isMQTTConnected) {
                showToast('Vui l√≤ng k·∫øt n·ªëi MQTT tr∆∞·ªõc!', 'error');
                return;
            }
            
            const testMessage = {
                test: true,
                message: 'Test t·ª´ ESP32 Control Center',
                timestamp: Date.now()
            };
            
            try {
                state.mqttClient.publish('smartclock/test', JSON.stringify(testMessage));
                showToast('üì° ƒê√£ g·ª≠i test MQTT!', 'success');
            } catch (error) {
                showToast('‚ùå L·ªói test MQTT', 'error');
            }
        }
        
        // ================= UTILITY FUNCTIONS =================
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('vi-VN');
            document.getElementById('currentTimeClock').textContent = timeStr;
        }
        
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionStatus');
            if (connected) {
                indicator.innerHTML = '<span class="status-dot" style="background: #4CAF50; box-shadow: 0 0 10px #4CAF50;"></span><span>ƒê√£ k·∫øt n·ªëi</span>';
                indicator.style.color = '#4CAF50';
            } else {
                indicator.innerHTML = '<span class="status-dot"></span><span>Ch∆∞a k·∫øt n·ªëi</span>';
                indicator.style.color = '#f44336';
            }
        }
        
        function updateMQTTStatus(text, connected) {
            document.getElementById('mqttStatusText').textContent = text;
            const dot = document.getElementById('mqttStatusDot');
            if (connected) {
                dot.classList.add('connected');
            } else {
                dot.classList.remove('connected');
            }
        }
        
        function updateCameraInfo(data) {
            if (data.free_heap) {
                document.getElementById('statHeap').textContent = Math.round(data.free_heap / 1024) + ' KB';
            }
            if (data.uptime) {
                document.getElementById('statUptime').textContent = data.uptime;
            }
        }
        
        function startFPSCounter() {
            const video = document.getElementById('videoStream');
            
            video.onload = function() {
                state.frameCount++;
                updateFPS();
            };
        }
        
        function updateFPS() {
            const now = Date.now();
            if (now - state.lastFpsUpdate >= 1000) {
                state.fps = state.frameCount;
                document.getElementById('statFps').textContent = state.fps;
                state.frameCount = 0;
                state.lastFpsUpdate = now;
            }
        }
        
        function requestStatusUpdate() {
            if (state.currentCamera) {
                fetch(`${state.currentCamera}${APP_CONFIG.apiEndpoints.status}`)
                    .then(response => response.json())
                    .then(data => {
                        updateCameraInfo(data);
                        
                        // Update latency
                        fetch(`${state.currentCamera}${APP_CONFIG.apiEndpoints.capture}`)
                            .then(() => {
                                state.latency = Date.now() - startTime;
                                document.getElementById('statLatency').textContent = state.latency + ' ms';
                            });
                            
                        showToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'success');
                    })
                    .catch(() => {
                        showToast('‚ùå L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'error');
                    });
            }
        }
        
        // ================= CAMERA HISTORY =================
        function saveCameraToHistory(url, name) {
            // Escape HTML ƒë·ªÉ tr√°nh XSS
            const escapedUrl = escapeHtml(url);
            const escapedName = escapeHtml(name);
            
            const camera = {
                url: escapedUrl,
                name: escapedName,
                ip: escapedUrl.replace('http://', ''),
                timestamp: Date.now()
            };
            
            // Remove duplicates
            state.cameraList = state.cameraList.filter(cam => cam.url !== escapedUrl);
            
            // Add to beginning and limit to 5
            state.cameraList.unshift(camera);
            if (state.cameraList.length > 5) {
                state.cameraList = state.cameraList.slice(0, 5);
            }
            
            // Save to localStorage
            localStorage.setItem(
                APP_CONFIG.localStorageKeys.cameraHistory,
                JSON.stringify(state.cameraList)
            );
            
            localStorage.setItem(
                APP_CONFIG.localStorageKeys.lastCamera,
                JSON.stringify({ ip: camera.ip, name: camera.name, url: camera.url })
            );
            
            renderCameraList();
        }
        
        function loadCameraHistory() {
            try {
                const saved = localStorage.getItem(APP_CONFIG.localStorageKeys.cameraHistory);
                if (saved) {
                    state.cameraList = JSON.parse(saved);
                    renderCameraList();
                }
            } catch (error) {
                console.error('Error loading camera history:', error);
            }
        }
        
        function renderCameraList() {
            const container = document.getElementById('cameraList');
            
            if (state.cameraList.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;padding:10px;">Ch∆∞a c√≥ camera</p>';
                return;
            }
            
            container.innerHTML = '';
            
            state.cameraList.forEach((camera, index) => {
                const item = document.createElement('div');
                item.className = 'camera-item';
                
                const infoDiv = document.createElement('div');
                infoDiv.style.flex = '1';
                
                const nameDiv = document.createElement('div');
                nameDiv.style.fontWeight = '600';
                nameDiv.style.fontSize = '13px';
                nameDiv.textContent = camera.name;
                
                const ipDiv = document.createElement('div');
                ipDiv.style.fontSize = '11px';
                ipDiv.style.color = '#666';
                ipDiv.textContent = camera.ip;
                
                infoDiv.appendChild(nameDiv);
                infoDiv.appendChild(ipDiv);
                
                const actionsDiv = document.createElement('div');
                actionsDiv.style.display = 'flex';
                actionsDiv.style.gap = '5px';
                
                // Connect button
                const connectBtn = document.createElement('button');
                connectBtn.innerHTML = '<i class="fas fa-plug"></i>';
                connectBtn.style.background = '#4a6fa5';
                connectBtn.style.color = 'white';
                connectBtn.style.border = 'none';
                connectBtn.style.width = '24px';
                connectBtn.style.height = '24px';
                connectBtn.style.borderRadius = '4px';
                connectBtn.style.cursor = 'pointer';
                connectBtn.style.fontSize = '12px';
                connectBtn.onclick = () => {
                    document.getElementById('cameraIp').value = camera.ip.split(':')[0];
                    connectCamera();
                };
                
                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.style.background = '#dc3545';
                deleteBtn.style.color = 'white';
                deleteBtn.style.border = 'none';
                deleteBtn.style.width = '24px';
                deleteBtn.style.height = '24px';
                deleteBtn.style.borderRadius = '4px';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.fontSize = '12px';
                deleteBtn.onclick = () => removeCamera(index);
                
                actionsDiv.appendChild(connectBtn);
                actionsDiv.appendChild(deleteBtn);
                
                item.appendChild(infoDiv);
                item.appendChild(actionsDiv);
                
                container.appendChild(item);
            });
        }
        
        function removeCamera(index) {
            if (confirm('X√≥a camera n√†y kh·ªèi l·ªãch s·ª≠?')) {
                state.cameraList.splice(index, 1);
                localStorage.setItem(
                    APP_CONFIG.localStorageKeys.cameraHistory,
                    JSON.stringify(state.cameraList)
                );
                renderCameraList();
                showToast('ƒê√£ x√≥a camera', 'info');
            }
        }
        
        function clearSavedCameras() {
            if (confirm('X√≥a t·∫•t c·∫£ camera ƒë√£ l∆∞u?')) {
                state.cameraList = [];
                localStorage.removeItem(APP_CONFIG.localStorageKeys.cameraHistory);
                localStorage.removeItem(APP_CONFIG.localStorageKeys.lastCamera);
                renderCameraList();
                showToast('ƒê√£ x√≥a t·∫•t c·∫£ camera', 'info');
            }
        }
        
        // ================= SETTINGS =================
        function loadSettings() {
            try {
                const saved = localStorage.getItem(APP_CONFIG.localStorageKeys.settings);
                state.settings = saved ? JSON.parse(saved) : { ...APP_CONFIG.defaultSettings };
                
                // Apply to UI
                document.getElementById('qualitySlider').value = state.settings.quality;
                document.getElementById('qualityValue').textContent = state.settings.quality;
                document.getElementById('brightnessSlider').value = state.settings.brightness;
                document.getElementById('brightnessValue').textContent = state.settings.brightness;
                
                // Auto-connect to last camera
                const lastCamera = localStorage.getItem(APP_CONFIG.localStorageKeys.lastCamera);
                if (lastCamera && state.settings.autoConnect) {
                    try {
                        const camera = JSON.parse(lastCamera);
                        if (camera.ip) {
                            document.getElementById('cameraIp').value = camera.ip;
                            setTimeout(() => {
                                if (confirm('T·ª± ƒë·ªông k·∫øt n·ªëi ƒë·∫øn camera cu·ªëi c√πng?')) {
                                    connectCamera();
                                }
                            }, 2000);
                        }
                    } catch (e) {
                        console.log('No valid last camera found');
                    }
                }
                
            } catch (error) {
                state.settings = { ...APP_CONFIG.defaultSettings };
            }
        }
        
        function saveSettings() {
            localStorage.setItem(
                APP_CONFIG.localStorageKeys.settings,
                JSON.stringify(state.settings)
            );
        }
        
        // ================= HELPER FUNCTIONS =================
        function fetchWithTimeout(url, options = {}) {
            const { timeout = 5000, ...fetchOptions } = options;
            
            return Promise.race([
                fetch(url, fetchOptions),
                new Promise((_, reject) =>
                    setTimeout(() => reject(new Error('Request timeout')), timeout)
                )
            ]);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const colors = {
                success: '#4CAF50',
                error: '#f44336',
                warning: '#ff9800',
                info: '#2196F3'
            };
            
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            toast.className = 'toast';
            toast.style.borderLeft = `4px solid ${colors[type] || colors.info}`;
            toast.innerHTML = `
                <i class="fas fa-${icons[type] || icons.info}" style="color: ${colors[type] || colors.info};"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function showQRCode() {
            const url = window.location.href;
            const canvas = document.getElementById('qrCanvas');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Generate QR code
            QRCode.toCanvas(canvas, url, {
                width: canvas.width,
                height: canvas.height,
                margin: 1,
                color: {
                    dark: '#000000',
                    light: '#FFFFFF'
                }
            }, function(error) {
                if (error) {
                    console.error('QR Code error:', error);
                    showToast('L·ªói t·∫°o QR Code', 'error');
                    return;
                }
                
                // Show modal
                document.getElementById('qrModal').style.display = 'flex';
            });
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function sharePage() {
            if (navigator.share) {
                navigator.share({
                    title: 'ESP32 Control Center',
                    text: 'ƒêi·ªÅu khi·ªÉn ESP32-CAM v√† Smart Clock t·ª´ xa',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href)
                    .then(() => showToast('‚úÖ ƒê√£ copy link v√†o clipboard', 'success'))
                    .catch(() => {
                        // Fallback
                        const textarea = document.createElement('textarea');
                        textarea.value = window.location.href;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        showToast('‚úÖ ƒê√£ copy link v√†o clipboard', 'success');
                    });
            }
        }
        
        // ================= EXPORT FUNCTIONS =================
        window.startStream = startStream;
        window.stopStream = stopStream;
        window.captureImage = captureImage;
        window.takeSnapshot = takeSnapshot;
        window.toggleFlash = toggleFlash;
        window.fullscreen = fullscreen;
        window.connectCamera = connectCamera;
        window.testCamera = testCamera;
        window.connectToCamera = connectToCamera;
        window.removeCamera = removeCamera;
        window.clearSavedCameras = clearSavedCameras;
        window.updateQuality = updateQuality;
        window.updateBrightness = updateBrightness;
        window.applySettings = applySettings;
        window.rebootCamera = rebootCamera;
        window.connectMQTT = connectMQTT;
        window.disconnectMQTT = disconnectMQTT;
        window.testMQTT = testMQTT;
        window.setAlarmMQTT = setAlarmMQTT;
        window.snoozeAlarmMQTT = snoozeAlarmMQTT;
        window.resetESP32MQTT = resetESP32MQTT;
        window.requestStatusUpdate = requestStatusUpdate;
        window.showQRCode = showQRCode;
        window.sharePage = sharePage;
        window.closeModal = closeModal;
        
        console.log('ESP32 Control Center initialized successfully!');
    </script>
</body>
</html>

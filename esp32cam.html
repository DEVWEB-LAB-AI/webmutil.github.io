<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-CAM Universal Viewer</title>
    <style>
        /* Giữ nguyên CSS của bạn nhưng thêm */
        .connection-methods {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .method-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .method-tab {
            padding: 10px 20px;
            background: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .method-tab.active {
            background: #4CAF50;
            color: white;
        }
        .method-content {
            display: none;
        }
        .method-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Thêm phần chọn phương thức kết nối -->
    <div class="connection-methods">
        <h3><i class="fas fa-plug"></i> Chọn phương thức kết nối</h3>
        <div class="method-tabs">
            <button class="method-tab active" onclick="showMethod('direct')">Trực tiếp</button>
            <button class="method-tab" onclick="showMethod('mDNS')">mDNS</button>
            <button class="method-tab" onclick="showMethod('discovery')">Tự động tìm</button>
            <button class="method-tab" onclick="showMethod('cloud')">Qua Cloud</button>
        </div>
        
        <div id="directMethod" class="method-content active">
            <input type="text" id="directIp" placeholder="Nhập IP ESP32" value="192.168.1.100">
            <button onclick="connectDirect()">Kết nối</button>
        </div>
        
        <div id="mDNSMethod" class="method-content">
            <p>Tự động phát hiện ESP32-CAM trên mạng nội bộ</p>
            <button onclick="discoverMDNS()">Tìm kiếm ESP32-CAM</button>
            <div id="mdnsResults"></div>
        </div>
        
        <div id="discoveryMethod" class="method-content">
            <p>Quét toàn bộ mạng để tìm ESP32-CAM</p>
            <button onclick="scanNetwork()">Quét mạng</button>
            <div id="scanResults"></div>
        </div>
        
        <div id="cloudMethod" class="method-content">
            <p>Kết nối qua internet (cần cấu hình port forwarding)</p>
            <input type="text" id="publicIp" placeholder="IP public hoặc domain">
            <input type="text" id="publicPort" placeholder="Port" value="8080">
            <button onclick="connectCloud()">Kết nối Cloud</button>
        </div>
    </div>
    
    <script>
        // JavaScript mới cho kết nối đa phương thức
        
        let currentMethod = 'direct';
        let wsConnection = null;
        
        function showMethod(method) {
            document.querySelectorAll('.method-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.method-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(method + 'Method').classList.add('active');
            currentMethod = method;
        }
        
        // Kết nối trực tiếp
        async function connectDirect() {
            const ip = document.getElementById('directIp').value;
            if (!ip) return alert('Vui lòng nhập IP');
            
            // Kiểm tra kết nối
            try {
                const response = await fetch(`http://${ip}/status`, { 
                    mode: 'cors',
                    timeout: 3000 
                });
                
                if (response.ok) {
                    const data = await response.json();
                    startStreaming(ip);
                    showNotification(`✅ Đã kết nối đến ${ip}`);
                }
            } catch (error) {
                // Thử kết nối qua HTTPS nếu HTTP không hoạt động
                try {
                    const response = await fetch(`http://${ip}:80/status`, {
                        mode: 'no-cors'
                    });
                    startStreaming(ip);
                } catch {
                    alert('Không thể kết nối. Thử phương thức khác.');
                }
            }
        }
        
        // Phát hiện mDNS
        async function discoverMDNS() {
            try {
                // Sử dụng WebRTC để phát hiện thiết bị trong mạng nội bộ
                const ips = await discoverLocalDevices();
                document.getElementById('mdnsResults').innerHTML = 
                    `<p>Tìm thấy ${ips.length} thiết bị</p>`;
                    
                // Thử kết nối đến từng thiết bị
                for (let ip of ips) {
                    try {
                        const response = await fetch(`http://${ip}/info`, { timeout: 1000 });
                        if (response.ok) {
                            document.getElementById('mdnsResults').innerHTML += 
                                `<button onclick="connectDirectTo('${ip}')">ESP32-CAM tại ${ip}</button>`;
                        }
                    } catch {}
                }
            } catch (error) {
                console.log('MDNS discovery failed:', error);
            }
        }
        
        // Quét mạng
        async function scanNetwork() {
            const results = document.getElementById('scanResults');
            results.innerHTML = '<p>Đang quét... (có thể mất 1 phút)</p>';
            
            // Quét subnet hiện tại
            const currentIp = await getCurrentIP();
            const subnet = currentIp.substring(0, currentIp.lastIndexOf('.'));
            
            const devices = [];
            
            // Quét 50 địa chỉ IP đầu tiên (thường là thiết bị IoT)
            for (let i = 1; i <= 50; i++) {
                const ip = `${subnet}.${i}`;
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 500);
                    
                    const response = await fetch(`http://${ip}/info`, {
                        signal: controller.signal,
                        mode: 'no-cors'
                    });
                    
                    clearTimeout(timeoutId);
                    devices.push(ip);
                    
                    results.innerHTML += `<p>✓ Tìm thấy ESP32 tại ${ip}</p>`;
                } catch (error) {
                    // Bỏ qua lỗi
                }
            }
            
            if (devices.length > 0) {
                results.innerHTML += `<p><strong>Chọn ESP32 để kết nối:</strong></p>`;
                devices.forEach(ip => {
                    results.innerHTML += 
                        `<button onclick="connectDirectTo('${ip}')">Kết nối ${ip}</button>`;
                });
            } else {
                results.innerHTML = '<p>Không tìm thấy ESP32 trong mạng</p>';
            }
        }
        
        // Kết nối Cloud
        async function connectCloud() {
            const ip = document.getElementById('publicIp').value;
            const port = document.getElementById('publicPort').value || '80';
            
            // Thử kết nối qua WebSocket trước
            try {
                wsConnection = new WebSocket(`ws://${ip}:${port}`);
                
                wsConnection.onopen = () => {
                    showNotification('✅ Kết nối WebSocket thành công');
                    startCloudStream(ip, port);
                };
                
                wsConnection.onerror = () => {
                    // Fallback về HTTP
                    startCloudStream(ip, port);
                };
            } catch (error) {
                startCloudStream(ip, port);
            }
        }
        
        // Hàm helper
        function connectDirectTo(ip) {
            document.getElementById('directIp').value = ip;
            connectDirect();
        }
        
        async function getCurrentIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return '192.168.1.100'; // Fallback
            }
        }
        
        function startStreaming(ip) {
            // Sửa URL stream để tránh cache
            const streamUrl = `http://${ip}/stream?t=${Date.now()}`;
            document.getElementById('videoStream').src = streamUrl;
            
            // Cập nhật UI
            document.getElementById('currentIp').textContent = ip;
            updateStatus('Đang stream', 'connected');
            
            // Lưu vào history
            saveToHistory(ip);
        }
        
        function startCloudStream(ip, port) {
            // Cloud streaming với retry logic
            const streamUrl = `http://${ip}:${port}/stream?t=${Date.now()}`;
            const video = document.getElementById('videoStream');
            
            video.src = streamUrl;
            video.onerror = () => {
                // Thử lại với giao thức khác
                setTimeout(() => {
                    video.src = `http://${ip}:${port}/stream?t=${Date.now()}`;
                }, 2000);
            };
        }
        
        function saveToHistory(ip) {
            let history = JSON.parse(localStorage.getItem('esp32_history') || '[]');
            if (!history.includes(ip)) {
                history.unshift(ip);
                if (history.length > 10) history.pop();
                localStorage.setItem('esp32_history', JSON.stringify(history));
            }
        }
        
        // Khởi tạo
        document.addEventListener('DOMContentLoaded', function() {
            // Tải lịch sử kết nối
            const history = JSON.parse(localStorage.getItem('esp32_history') || '[]');
            if (history.length > 0) {
                document.getElementById('directIp').value = history[0];
            }
            
            // Tự động thử kết nối nếu có history
            if (history.length > 0) {
                setTimeout(() => {
                    connectDirectTo(history[0]);
                }, 1000);
            }
        });
    </script>
</body>
</html>

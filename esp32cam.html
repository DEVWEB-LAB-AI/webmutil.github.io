<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-CAM Remote Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            min-height: 100vh;
            color: #333;
        }
        
        /* Navigation Bar */
        .nav-bar {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-link {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .nav-link i {
            font-size: 1.1rem;
        }
        
        .nav-logo h3 {
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        header h1 {
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .nav-bar {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
        
        .video-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        #videoStream {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .video-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #2196F3;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #0b7dda;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }
        
        .connection-form {
            margin-bottom: 25px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .status-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .status-label {
            font-weight: 600;
            color: #666;
        }
        
        .status-value {
            color: #333;
        }
        
        .connected {
            color: #4CAF50;
            font-weight: 600;
        }
        
        .disconnected {
            color: #f44336;
            font-weight: 600;
        }
        
        .settings-section {
            margin-top: 25px;
        }
        
        .settings-section h3 {
            margin-bottom: 15px;
            color: #555;
        }
        
        .slider-container {
            margin-bottom: 15px;
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            color: #666;
        }
        
        .slider-container input {
            width: 100%;
        }
        
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .login-box h2 {
            margin-bottom: 25px;
            color: #333;
        }
        
        .login-box input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .login-box button {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .login-box button:hover {
            background: #45a049;
        }
        
        .error-message {
            color: #f44336;
            margin-top: 10px;
            display: none;
        }
        
        .quality-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .active {
            background: #2196F3 !important;
        }
        
        .screenshot-container {
            margin-top: 20px;
            text-align: center;
        }
        
        #screenshot {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: white;
            padding: 20px;
            opacity: 0.8;
        }
        
        /* Saved cameras styling */
        .saved-camera {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #ddd;
        }
        
        .saved-camera button {
            padding: 6px 12px;
            margin-left: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .saved-camera button:first-of-type {
            background: #4CAF50;
            color: white;
        }
        
        .saved-camera button:last-of-type {
            background: #f44336;
            color: white;
        }
        
        .quick-nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .quick-nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            transition: all 0.3s;
        }
        
        .quick-nav a:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation Bar -->
    <div class="nav-bar">
        <div class="nav-logo">
            <h3>
                <i class="fas fa-microchip"></i>
                ESP32 Control Hub
            </h3>
        </div>
        <div class="nav-links">
            <a href="index.html" class="nav-link">
                <i class="fas fa-home"></i>
                Trang ch·ªß
            </a>
            <a href="espcam.html" class="nav-link">
                <i class="fas fa-camera"></i>
                Camera View
            </a>
            <a href="camera-dashboard.html" class="nav-link">
                <i class="fas fa-tv"></i>
                Dashboard Camera
            </a>
        </div>
    </div>
    
    <div class="container">
        <header>
            <h1><i class="fas fa-camera"></i> ESP32-CAM Remote Viewer</h1>
            <p>Xem camera ESP32 t·ª´ xa v·ªõi b·∫£o m·∫≠t cao</p>
        </header>
        
        <div class="main-content">
            <div class="video-section">
                <div class="video-container">
                    <img id="videoStream" src="" alt="Live Stream">
                </div>
                
                <div class="video-controls">
                    <button class="btn btn-primary" onclick="startStream()">
                        <i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu stream
                    </button>
                    <button class="btn btn-secondary" onclick="stopStream()">
                        <i class="fas fa-stop"></i> D·ª´ng stream
                    </button>
                    <button class="btn btn-secondary" onclick="takeSnapshot()">
                        <i class="fas fa-camera"></i> Ch·ª•p ·∫£nh
                    </button>
                    <button class="btn btn-warning" onclick="openFullscreen()">
                        <i class="fas fa-expand"></i> To√†n m√†n h√¨nh
                    </button>
                    <button class="btn btn-danger" onclick="toggleLogin()">
                        <i class="fas fa-lock"></i> ƒêƒÉng nh·∫≠p
                    </button>
                </div>
                
                <div class="quality-controls">
                    <button class="btn btn-small" onclick="setQuality('low')">Ch·∫•t l∆∞·ª£ng th·∫•p</button>
                    <button class="btn btn-small active" onclick="setQuality('medium')">Ch·∫•t l∆∞·ª£ng trung b√¨nh</button>
                    <button class="btn btn-small" onclick="setQuality('high')">Ch·∫•t l∆∞·ª£ng cao</button>
                    <button class="btn btn-small" onclick="toggleFaceDetection()">
                        <i class="fas fa-user"></i> Ph√°t hi·ªán khu√¥n m·∫∑t
                    </button>
                </div>
                
                <div class="screenshot-container">
                    <h3>·∫¢nh v·ª´a ch·ª•p:</h3>
                    <img id="screenshot" alt="Screenshot">
                </div>
            </div>
            
            <div class="control-panel">
                <div class="connection-form">
                    <h3><i class="fas fa-wifi"></i> K·∫øt n·ªëi ESP32</h3>
                    <div class="form-group">
                        <label for="espIp">ƒê·ªãa ch·ªâ IP ESP32:</label>
                        <input type="text" id="espIp" placeholder="V√≠ d·ª•: 192.168.1.100">
                    </div>
                    <div class="form-group">
                        <label for="port">C·ªïng:</label>
                        <input type="text" id="port" value="80" readonly>
                    </div>
                    <button class="btn btn-primary" onclick="saveConnection()">
                        <i class="fas fa-save"></i> L∆∞u c·∫•u h√¨nh
                    </button>
                </div>
                
                <div class="status-panel">
                    <h3><i class="fas fa-info-circle"></i> Tr·∫°ng th√°i</h3>
                    <div class="status-item">
                        <span class="status-label">K·∫øt n·ªëi:</span>
                        <span id="connectionStatus" class="status-value disconnected">Ch∆∞a k·∫øt n·ªëi</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ESP32 IP:</span>
                        <span id="currentIp" class="status-value">-</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">FPS:</span>
                        <span id="fpsCounter" class="status-value">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ƒê·ªô tr·ªÖ:</span>
                        <span id="latency" class="status-value">- ms</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">B·ªô nh·ªõ:</span>
                        <span id="memoryUsage" class="status-value">-</span>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-cog"></i> C√†i ƒë·∫∑t</h3>
                    <div class="slider-container">
                        <label for="brightness">ƒê·ªô s√°ng:</label>
                        <input type="range" id="brightness" min="0" max="100" value="50">
                    </div>
                    <div class="slider-container">
                        <label for="contrast">ƒê·ªô t∆∞∆°ng ph·∫£n:</label>
                        <input type="range" id="contrast" min="0" max="100" value="50">
                    </div>
                    <div class="slider-container">
                        <label for="rotation">Xoay camera:</label>
                        <select id="rotation" class="form-group" style="width:100%; padding:12px; border:2px solid #ddd; border-radius:8px;">
                            <option value="0">0¬∞ - B√¨nh th∆∞·ªùng</option>
                            <option value="90">90¬∞ - Ph·∫£i</option>
                            <option value="180">180¬∞ - L·∫≠t ng∆∞·ª£c</option>
                            <option value="270">270¬∞ - Tr√°i</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="applySettings()">
                        <i class="fas fa-check"></i> √Åp d·ª•ng c√†i ƒë·∫∑t
                    </button>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-history"></i> Camera ƒë√£ l∆∞u</h3>
                    <div id="savedCameras">
                        <!-- Danh s√°ch camera s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                    </div>
                    <button class="btn btn-small" onclick="clearAllCameras()" style="width:100%; margin-top:10px; background:#f44336;">
                        <i class="fas fa-trash"></i> X√≥a t·∫•t c·∫£
                    </button>
                </div>
                
                <div class="settings-section">
                    <h3><i class="fas fa-bolt"></i> H√†nh ƒë·ªông nhanh</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-small" onclick="flashOn()" style="background:#ff9800;">
                            <i class="fas fa-lightbulb"></i> B·∫≠t ƒë√®n
                        </button>
                        <button class="btn btn-small" onclick="flashOff()" style="background:#2196F3;">
                            <i class="fas fa-lightbulb"></i> T·∫Øt ƒë√®n
                        </button>
                        <button class="btn btn-small" onclick="rebootCamera()" style="background:#9C27B0;">
                            <i class="fas fa-redo"></i> Kh·ªüi ƒë·ªông l·∫°i
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>¬© 2024 ESP32-CAM Remote Viewer | B·∫£o m·∫≠t cao | Multi-WiFi Support</p>
            <p>K·∫øt n·ªëi an to√†n v·ªõi m·∫≠t kh·∫©u ƒë∆∞·ª£c m√£ h√≥a</p>
            <div class="quick-nav">
                <a href="index.html"><i class="fas fa-home"></i> Trang ch·ªß</a>
                <a href="camera-dashboard.html"><i class="fas fa-tv"></i> Dashboard</a>
                <a href="espcam.html"><i class="fas fa-camera"></i> Single View</a>
            </div>
        </footer>
    </div>
    
    <!-- Modal ƒëƒÉng nh·∫≠p -->
    <div id="loginModal" class="login-modal">
        <div class="login-box">
            <h2><i class="fas fa-lock"></i> ƒêƒÉng nh·∫≠p b·∫£o m·∫≠t</h2>
            <p>Vui l√≤ng nh·∫≠p th√¥ng tin ƒëƒÉng nh·∫≠p ESP32</p>
            <input type="text" id="loginUsername" placeholder="T√™n ƒëƒÉng nh·∫≠p" value="admin">
            <input type="password" id="loginPassword" placeholder="M·∫≠t kh·∫©u" value="admin">
            <button onclick="authenticate()">ƒêƒÉng nh·∫≠p</button>
            <div id="loginError" class="error-message">Sai th√¥ng tin ƒëƒÉng nh·∫≠p!</div>
            <p style="margin-top: 15px; font-size: 12px; color: #666;">
                <i class="fas fa-info-circle"></i> M·∫∑c ƒë·ªãnh: admin/admin
            </p>
        </div>
    </div>
    
    <script>
        // Bi·∫øn to√†n c·ª•c
        let streamInterval;
        let isStreaming = false;
        let currentQuality = 'medium';
        let espIp = '';
        let authCookie = '';
        let fpsCount = 0;
        let fpsTimer = null;
        let faceDetection = false;
        
        // Kh·ªüi t·∫°o - Load IP t·ª´ URL ho·∫∑c localStorage
        document.addEventListener('DOMContentLoaded', function() {
            // Ki·ªÉm tra xem c√≥ IP t·ª´ URL kh√¥ng (khi m·ªü t·ª´ dashboard)
            const urlParams = new URLSearchParams(window.location.search);
            const ipFromUrl = urlParams.get('ip');
            const nameFromUrl = urlParams.get('name');
            
            if (ipFromUrl) {
                document.getElementById('espIp').value = ipFromUrl;
                espIp = ipFromUrl;
                if (nameFromUrl) {
                    document.querySelector('header h1').innerHTML = 
                        `<i class="fas fa-camera"></i> ${decodeURIComponent(nameFromUrl)}`;
                }
                // T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu stream sau 1 gi√¢y
                setTimeout(() => startStream(), 1000);
            } else {
                // Load t·ª´ localStorage n·∫øu kh√¥ng c√≥ t·ª´ URL
                const savedIp = localStorage.getItem('esp32cam_ip');
                if(savedIp) {
                    document.getElementById('espIp').value = savedIp;
                    espIp = savedIp;
                    updateStatus('ƒê√£ l∆∞u IP', 'connected');
                    document.getElementById('currentIp').textContent = savedIp;
                }
            }
            
            loadSavedCameras();
            
            // C·∫≠p nh·∫≠t FPS m·ªói gi√¢y
            setInterval(() => {
                document.getElementById('fpsCounter').textContent = fpsCount;
                fpsCount = 0;
            }, 1000);
            
            // C·∫≠p nh·∫≠t ƒë·ªô tr·ªÖ m·ªói 5 gi√¢y
            setInterval(updateLatency, 5000);
            
            // T·ª± ƒë·ªông k·∫øt n·ªëi n·∫øu c√≥ IP
            if (espIp && ipFromUrl) {
                setTimeout(() => startStream(), 1500);
            }
        });
        
        // B·∫Øt ƒë·∫ßu stream
        function startStream() {
            const ip = document.getElementById('espIp').value;
            if(!ip) {
                alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ IP ESP32');
                return;
            }
            
            espIp = ip;
            stopStream(); // D·ª´ng stream c≈© n·∫øu c√≥
            
            const streamUrl = `http://${espIp}/stream`;
            const videoElement = document.getElementById('videoStream');
            videoElement.src = streamUrl;
            videoElement.onerror = () => {
                updateStatus('L·ªói k·∫øt n·ªëi', 'disconnected');
                alert('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn ESP32. Vui l√≤ng ki·ªÉm tra IP v√† m·∫°ng.');
                stopStream();
            };
            
            videoElement.onload = () => {
                updateStatus('ƒêang stream', 'connected');
            };
            
            isStreaming = true;
            
            // L∆∞u IP v√†o localStorage
            localStorage.setItem('esp32cam_ip', ip);
            document.getElementById('currentIp').textContent = ip;
            
            // C·∫≠p nh·∫≠t FPS
            streamInterval = setInterval(() => {
                fpsCount++;
            }, 100);
            
            // C·∫≠p nh·∫≠t camera ƒë√£ l∆∞u
            saveCameraToHistory(ip);
            
            // C·∫≠p nh·∫≠t th√¥ng tin b·ªô nh·ªõ (gi·∫£ l·∫≠p)
            updateMemoryInfo();
        }
        
        // D·ª´ng stream
        function stopStream() {
            document.getElementById('videoStream').src = '';
            isStreaming = false;
            updateStatus('ƒê√£ d·ª´ng', 'disconnected');
            if(streamInterval) {
                clearInterval(streamInterval);
            }
        }
        
        // Ch·ª•p ·∫£nh
        function takeSnapshot() {
            if(!espIp) {
                alert('Vui l√≤ng k·∫øt n·ªëi ƒë·∫øn ESP32 tr∆∞·ªõc');
                return;
            }
            
            const timestamp = new Date().getTime();
            const captureUrl = `http://${espIp}/capture?_cb=${timestamp}`;
            
            // Hi·ªÉn th·ªã ·∫£nh ch·ª•p
            const screenshot = document.getElementById('screenshot');
            screenshot.src = captureUrl;
            screenshot.style.display = 'block';
            
            // T·∫£i ·∫£nh v·ªÅ
            const link = document.createElement('a');
            link.href = captureUrl;
            link.download = `esp32-capture-${timestamp}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('üì∏ ƒê√£ ch·ª•p v√† t·∫£i ·∫£nh v·ªÅ');
        }
        
        // ƒê·∫∑t ch·∫•t l∆∞·ª£ng
        function setQuality(quality) {
            currentQuality = quality;
            
            // C·∫≠p nh·∫≠t n√∫t b·∫•m
            document.querySelectorAll('.quality-controls .btn-small').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if(isStreaming && espIp) {
                // G·ª≠i y√™u c·∫ßu thay ƒë·ªïi ch·∫•t l∆∞·ª£ng ƒë·∫øn ESP32
                fetch(`http://${espIp}/control?quality=${quality}`, {
                    credentials: 'include'
                }).then(() => {
                    showNotification(`‚úÖ ƒê√£ ƒë·∫∑t ch·∫•t l∆∞·ª£ng: ${quality}`);
                }).catch(err => {
                    console.log('Kh√¥ng th·ªÉ thay ƒë·ªïi ch·∫•t l∆∞·ª£ng:', err);
                });
            }
        }
        
        // L∆∞u k·∫øt n·ªëi
        function saveConnection() {
            const ip = document.getElementById('espIp').value;
            if(ip) {
                localStorage.setItem('esp32cam_ip', ip);
                showNotification('üíæ ƒê√£ l∆∞u c·∫•u h√¨nh k·∫øt n·ªëi!');
                saveCameraToHistory(ip);
            }
        }
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i
        function updateStatus(message, className) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = message;
            statusElement.className = `status-value ${className}`;
        }
        
        // Hi·ªÉn th·ªã/·∫©n modal ƒëƒÉng nh·∫≠p
        function toggleLogin() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'flex';
        }
        
        // X√°c th·ª±c
        function authenticate() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if(!espIp) {
                document.getElementById('loginError').textContent = 'Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ IP ESP32 tr∆∞·ªõc';
                document.getElementById('loginError').style.display = 'block';
                return;
            }
            
            // G·ª≠i y√™u c·∫ßu ƒëƒÉng nh·∫≠p ƒë·∫øn ESP32
            const formData = new FormData();
            formData.append('USERNAME', username);
            formData.append('PASSWORD', password);
            
            fetch(`http://${espIp}/login`, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            })
            .then(response => {
                if(response.redirected) {
                    // ƒêƒÉng nh·∫≠p th√†nh c√¥ng
                    document.getElementById('loginModal').style.display = 'none';
                    showNotification('üîì ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
                    startStream(); // B·∫Øt ƒë·∫ßu stream sau khi ƒëƒÉng nh·∫≠p
                } else {
                    // ƒêƒÉng nh·∫≠p th·∫•t b·∫°i
                    document.getElementById('loginError').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('L·ªói ƒëƒÉng nh·∫≠p:', error);
                document.getElementById('loginError').textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn ESP32';
                document.getElementById('loginError').style.display = 'block';
            });
        }
        
        // √Åp d·ª•ng c√†i ƒë·∫∑t
        function applySettings() {
            const brightness = document.getElementById('brightness').value;
            const contrast = document.getElementById('contrast').value;
            const rotation = document.getElementById('rotation').value;
            
            if(espIp) {
                fetch(`http://${espIp}/settings?brightness=${brightness}&contrast=${contrast}&rotation=${rotation}`, {
                    credentials: 'include'
                }).then(() => {
                    showNotification('‚öôÔ∏è ƒê√£ √°p d·ª•ng c√†i ƒë·∫∑t!');
                }).catch(err => {
                    showNotification('‚ùå Kh√¥ng th·ªÉ √°p d·ª•ng c√†i ƒë·∫∑t');
                });
            }
        }
        
        // L∆∞u camera v√†o l·ªãch s·ª≠
        function saveCameraToHistory(ip) {
            let cameras = JSON.parse(localStorage.getItem('esp32cam_history') || '[]');
            
            if(!cameras.includes(ip)) {
                cameras.unshift(ip);
                if(cameras.length > 10) cameras = cameras.slice(0, 10);
                localStorage.setItem('esp32cam_history', JSON.stringify(cameras));
                loadSavedCameras();
            }
        }
        
        // T·∫£i danh s√°ch camera ƒë√£ l∆∞u
        function loadSavedCameras() {
            const cameras = JSON.parse(localStorage.getItem('esp32cam_history') || '[]');
            const container = document.getElementById('savedCameras');
            container.innerHTML = '';
            
            if(cameras.length === 0) {
                container.innerHTML = '<p style="color:#666; text-align:center;">Ch∆∞a c√≥ camera n√†o</p>';
                return;
            }
            
            cameras.forEach(ip => {
                const div = document.createElement('div');
                div.className = 'saved-camera';
                div.innerHTML = `
                    <span><i class="fas fa-video"></i> ${ip}</span>
                    <div>
                        <button onclick="connectToCamera('${ip}')">K·∫øt n·ªëi</button>
                        <button onclick="removeCamera('${ip}')">X√≥a</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // K·∫øt n·ªëi ƒë·∫øn camera ƒë√£ l∆∞u
        function connectToCamera(ip) {
            document.getElementById('espIp').value = ip;
            espIp = ip;
            startStream();
        }
        
        // X√≥a camera kh·ªèi danh s√°ch
        function removeCamera(ip) {
            let cameras = JSON.parse(localStorage.getItem('esp32cam_history') || '[]');
            cameras = cameras.filter(camIp => camIp !== ip);
            localStorage.setItem('esp32cam_history', JSON.stringify(cameras));
            loadSavedCameras();
            showNotification('üóëÔ∏è ƒê√£ x√≥a camera kh·ªèi danh s√°ch');
        }
        
        // X√≥a t·∫•t c·∫£ camera
        function clearAllCameras() {
            if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ camera ƒë√£ l∆∞u?')) {
                localStorage.removeItem('esp32cam_history');
                loadSavedCameras();
                showNotification('üóëÔ∏è ƒê√£ x√≥a t·∫•t c·∫£ camera');
            }
        }
        
        // M·ªü to√†n m√†n h√¨nh
        function openFullscreen() {
            const videoContainer = document.querySelector('.video-container');
            if (videoContainer.requestFullscreen) {
                videoContainer.requestFullscreen();
            } else if (videoContainer.webkitRequestFullscreen) {
                videoContainer.webkitRequestFullscreen();
            } else if (videoContainer.msRequestFullscreen) {
                videoContainer.msRequestFullscreen();
            }
        }
        
        // B·∫≠t/t·∫Øt ph√°t hi·ªán khu√¥n m·∫∑t
        function toggleFaceDetection() {
            faceDetection = !faceDetection;
            const btn = event.target.closest('button');
            if(btn) {
                btn.innerHTML = `<i class="fas fa-user"></i> Ph√°t hi·ªán khu√¥n m·∫∑t ${faceDetection ? '‚úÖ' : '‚ùå'}`;
            }
            
            if(espIp && isStreaming) {
                fetch(`http://${espIp}/control?face=${faceDetection ? 1 : 0}`)
                    .then(() => showNotification(`üë§ ${faceDetection ? 'B·∫≠t' : 'T·∫Øt'} ph√°t hi·ªán khu√¥n m·∫∑t`))
                    .catch(err => console.log('L·ªói ƒëi·ªÅu khi·ªÉn face detection:', err));
            }
        }
        
        // C·∫≠p nh·∫≠t ƒë·ªô tr·ªÖ
        function updateLatency() {
            if(!isStreaming || !espIp) return;
            
            const startTime = Date.now();
            fetch(`http://${espIp}/status?_=${startTime}`)
                .then(() => {
                    const latency = Date.now() - startTime;
                    document.getElementById('latency').textContent = `${latency} ms`;
                })
                .catch(() => {
                    document.getElementById('latency').textContent = 'Timeout';
                });
        }
        
        // C·∫≠p nh·∫≠t th√¥ng tin b·ªô nh·ªõ
        function updateMemoryInfo() {
            // Gi·∫£ l·∫≠p th√¥ng tin b·ªô nh·ªõ
            const memory = Math.floor(Math.random() * 20) + 80;
            document.getElementById('memoryUsage').textContent = `${memory}%`;
        }
        
        // B·∫≠t ƒë√®n flash
        function flashOn() {
            if(espIp) {
                fetch(`http://${espIp}/control?flash=1`)
                    .then(() => showNotification('üí° B·∫≠t ƒë√®n flash'))
                    .catch(err => console.log('L·ªói b·∫≠t ƒë√®n:', err));
            }
        }
        
        // T·∫Øt ƒë√®n flash
        function flashOff() {
            if(espIp) {
                fetch(`http://${espIp}/control?flash=0`)
                    .then(() => showNotification('üí° T·∫Øt ƒë√®n flash'))
                    .catch(err => console.log('L·ªói t·∫Øt ƒë√®n:', err));
            }
        }
        
        // Kh·ªüi ƒë·ªông l·∫°i camera
        function rebootCamera() {
            if(espIp && confirm('Kh·ªüi ƒë·ªông l·∫°i ESP32-CAM? Camera s·∫Ω m·∫•t k·∫øt n·ªëi trong 10-15 gi√¢y.')) {
                fetch(`http://${espIp}/reboot`)
                    .then(() => showNotification('üîÑ ƒêang kh·ªüi ƒë·ªông l·∫°i...'))
                    .catch(err => console.log('L·ªói reboot:', err));
            }
        }
        
        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showNotification(message) {
            // T·∫°o toast notification ƒë∆°n gi·∫£n
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // ƒê√≥ng modal khi click b√™n ngo√†i
        window.onclick = function(event) {
            const modal = document.getElementById('loginModal');
            if(event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // Th√™m CSS animation cho toast
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>

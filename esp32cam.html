<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-CAM Modern Viewer</title>
    
    <!-- Dùng chung CSS từ các file khác nếu có -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* CSS riêng cho modern interface */
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --dark-color: #1a2980;
            --light-color: #26d0ce;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--dark-color), var(--light-color));
            min-height: 100vh;
            margin: 0;
            color: #333;
        }
        
        /* Navigation - giống các file khác để đồng bộ */
        .nav-bar {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
        }
        
        .nav-link {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-link:hover, .nav-link.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Grid layout hiện đại */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Video panel */
        .video-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16/9;
        }
        
        #videoStream {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .video-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: var(--secondary-color); color: white; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-warning { background: var(--warning-color); color: white; }
        
        /* Right panel */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .panel-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Camera list */
        .camera-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .camera-item.active {
            border-color: var(--primary-color);
            background: #e8f5e8;
        }
        
        /* Settings */
        .slider-group {
            margin: 15px 0;
        }
        
        .slider-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <div class="nav-bar">
        <div class="nav-logo">
            <h3><i class="fas fa-microchip"></i> ESP32 Control Hub</h3>
        </div>
        <div class="nav-links">
            <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Home</a>
            <a href="esp32cam.html" class="nav-link"><i class="fas fa-camera"></i> Basic View</a>
            <a href="camera-dashboard.html" class="nav-link"><i class="fas fa-tv"></i> Dashboard</a>
            <a href="modern-camera.html" class="nav-link active"><i class="fas fa-star"></i> Modern View</a>
            <a href="CORS-proxy.html" class="nav-link"><i class="fas fa-link"></i> CORS Proxy</a>
        </div>
    </div>
    
    <div class="container">
        <header style="text-align: center; color: white; margin-bottom: 30px;">
            <h1><i class="fas fa-video"></i> ESP32-CAM Modern Viewer</h1>
            <p>Giao diện hiện đại với đa kết nối và điều khiển nâng cao</p>
        </header>
        
        <div class="main-grid">
            <!-- Left: Video stream -->
            <div class="video-panel">
                <div class="video-container">
                    <img id="videoStream" src="" alt="Live Stream">
                    <div class="video-overlay">
                        <span id="fpsBadge" style="background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 20px;">0 FPS</span>
                        <span id="resolutionBadge" style="background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 20px;">-</span>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-primary" onclick="startStream()">
                        <i class="fas fa-play"></i> Start Stream
                    </button>
                    <button class="btn btn-danger" onclick="stopStream()">
                        <i class="fas fa-stop"></i> Stop Stream
                    </button>
                    <button class="btn btn-secondary" onclick="captureImage()">
                        <i class="fas fa-camera"></i> Capture
                    </button>
                    <button class="btn btn-warning" onclick="toggleFlash()">
                        <i class="fas fa-lightbulb"></i> Flash
                    </button>
                    <button class="btn btn-secondary" onclick="takeSnapshot()">
                        <i class="fas fa-download"></i> Snapshot
                    </button>
                    <button class="btn btn-primary" onclick="fullscreen()">
                        <i class="fas fa-expand"></i> Fullscreen
                    </button>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="cameraIp" placeholder="ESP32 IP Address" style="flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
                    <button class="btn btn-primary" onclick="connectToCamera()">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                    <button class="btn btn-secondary" onclick="scanForCameras()">
                        <i class="fas fa-search"></i> Scan
                    </button>
                </div>
            </div>
            
            <!-- Right: Control panels -->
            <div class="right-panel">
                <!-- Camera List -->
                <div class="panel-card">
                    <h3><i class="fas fa-list"></i> Saved Cameras</h3>
                    <div id="cameraList">
                        <!-- Dynamic content -->
                    </div>
                    <button class="btn btn-primary" onclick="addCurrentCamera()" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-plus"></i> Add Current Camera
                    </button>
                </div>
                
                <!-- Settings -->
                <div class="panel-card">
                    <h3><i class="fas fa-cog"></i> Camera Settings</h3>
                    
                    <div class="slider-group">
                        <label>Quality: <span id="qualityValue">Medium</span></label>
                        <input type="range" id="qualitySlider" min="1" max="63" value="10" onchange="updateQuality()">
                    </div>
                    
                    <div class="slider-group">
                        <label>Brightness: <span id="brightnessValue">50</span></label>
                        <input type="range" id="brightnessSlider" min="0" max="100" value="50" onchange="updateBrightness()">
                    </div>
                    
                    <div class="slider-group">
                        <label>Frame Size:</label>
                        <select id="frameSizeSelect" class="btn" style="width: 100%; padding: 10px;">
                            <option value="7">QVGA (320x240)</option>
                            <option value="8">CIF (400x296)</option>
                            <option value="9">VGA (640x480)</option>
                            <option value="10" selected>SVGA (800x600)</option>
                            <option value="11">XGA (1024x768)</option>
                            <option value="12">SXGA (1280x1024)</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" onclick="applySettings()" style="width: 100%;">
                        <i class="fas fa-check"></i> Apply Settings
                    </button>
                </div>
                
                <!-- Statistics -->
                <div class="panel-card">
                    <h3><i class="fas fa-chart-bar"></i> Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statFPS">0</div>
                            <div class="stat-label">FPS</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statLatency">-</div>
                            <div class="stat-label">Latency (ms)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statUptime">0</div>
                            <div class="stat-label">Uptime (s)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statHeap">-</div>
                            <div class="stat-label">Free Heap</div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="panel-card">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <button class="btn btn-warning" onclick="rebootCamera()">
                            <i class="fas fa-redo"></i> Reboot
                        </button>
                        <button class="btn btn-danger" onclick="resetSettings()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="btn btn-secondary" onclick="showQR()">
                            <i class="fas fa-qrcode"></i> Show QR
                        </button>
                        <button class="btn btn-primary" onclick="shareCamera()">
                            <i class="fas fa-share"></i> Share
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screenshot preview -->
        <div id="screenshotModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;">
            <div style="background: white; padding: 20px; border-radius: 10px; max-width: 90%; max-height: 90%;">
                <h3>Captured Image</h3>
                <img id="screenshotPreview" style="max-width: 100%; max-height: 70vh;">
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="downloadScreenshot()">Download</button>
                    <button class="btn btn-danger" onclick="closeScreenshot()">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Import config từ file chung nếu có
        // <script src="common-config.js"></script>
        
        // Biến ứng dụng
        let currentCameraIP = '';
        let isStreaming = false;
        let streamInterval;
        let fpsCounter = 0;
        let fpsTimer;
        let cameraList = [];
        
        // Khởi tạo
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved cameras
            loadSavedCameras();
            
            // Load last connected camera
            const lastCamera = localStorage.getItem('lastConnectedCamera');
            if (lastCamera) {
                document.getElementById('cameraIp').value = lastCamera;
                currentCameraIP = lastCamera;
                setTimeout(() => startStream(), 1000);
            }
            
            // Start FPS counter
            setInterval(() => {
                document.getElementById('statFPS').textContent = fpsCounter;
                document.getElementById('fpsBadge').textContent = `${fpsCounter} FPS`;
                fpsCounter = 0;
            }, 1000);
            
            // Update uptime
            setInterval(() => {
                const uptime = parseInt(document.getElementById('statUptime').textContent) + 1;
                document.getElementById('statUptime').textContent = uptime;
            }, 1000);
        });
        
        // Kết nối đến camera
        function connectToCamera() {
            const ip = document.getElementById('cameraIp').value.trim();
            if (!ip) {
                showToast('Please enter camera IP address', 'warning');
                return;
            }
            
            currentCameraIP = ip;
            localStorage.setItem('lastConnectedCamera', ip);
            
            // Kiểm tra kết nối
            checkCameraConnection(ip).then(connected => {
                if (connected) {
                    showToast(`Connected to ${ip}`, 'success');
                    updateCameraList(ip);
                    startStream();
                } else {
                    showToast(`Cannot connect to ${ip}`, 'error');
                }
            });
        }
        
        // Kiểm tra kết nối camera
        async function checkCameraConnection(ip) {
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 3000);
                
                const response = await fetch(`http://${ip}/status`, {
                    signal: controller.signal,
                    mode: 'no-cors'
                });
                
                clearTimeout(timeout);
                return true;
            } catch (error) {
                return false;
            }
        }
        
        // Bắt đầu stream
        function startStream() {
            if (!currentCameraIP) {
                showToast('No camera connected', 'error');
                return;
            }
            
            if (isStreaming) {
                stopStream();
            }
            
            const videoElement = document.getElementById('videoStream');
            const streamUrl = `http://${currentCameraIP}/stream?t=${Date.now()}`;
            
            videoElement.src = streamUrl;
            videoElement.onload = () => {
                isStreaming = true;
                showToast('Stream started', 'success');
                
                // Start FPS counting
                fpsTimer = setInterval(() => {
                    fpsCounter++;
                }, 100);
                
                // Update status
                updateCameraStatus();
            };
            
            videoElement.onerror = () => {
                showToast('Stream error. Check connection.', 'error');
                stopStream();
            };
        }
        
        // Dừng stream
        function stopStream() {
            const videoElement = document.getElementById('videoStream');
            videoElement.src = '';
            isStreaming = false;
            
            if (fpsTimer) {
                clearInterval(fpsTimer);
            }
            
            showToast('Stream stopped', 'info');
        }
        
        // Chụp ảnh
        function captureImage() {
            if (!currentCameraIP) return;
            
            const timestamp = Date.now();
            const captureUrl = `http://${currentCameraIP}/capture?_=${timestamp}`;
            
            const preview = document.getElementById('screenshotPreview');
            preview.src = captureUrl;
            
            const modal = document.getElementById('screenshotModal');
            modal.style.display = 'flex';
            
            showToast('Image captured', 'success');
        }
        
        // Tải ảnh
        function takeSnapshot() {
            if (!currentCameraIP) return;
            
            const timestamp = Date.now();
            const captureUrl = `http://${currentCameraIP}/capture?_=${timestamp}`;
            
            const link = document.createElement('a');
            link.href = captureUrl;
            link.download = `esp32-capture-${timestamp}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Image downloaded', 'success');
        }
        
        // Điều khiển flash
        function toggleFlash() {
            if (!currentCameraIP) return;
            
            fetch(`http://${currentCameraIP}/control?flash=1`)
                .then(() => showToast('Flash toggled', 'success'))
                .catch(err => showToast('Flash control failed', 'error'));
        }
        
        // Fullscreen
        function fullscreen() {
            const videoContainer = document.querySelector('.video-container');
            if (videoContainer.requestFullscreen) {
                videoContainer.requestFullscreen();
            }
        }
        
        // Tải danh sách camera đã lưu
        function loadSavedCameras() {
            const saved = JSON.parse(localStorage.getItem('esp32cam_saved') || '[]');
            cameraList = saved;
            renderCameraList();
        }
        
        // Render danh sách camera
        function renderCameraList() {
            const container = document.getElementById('cameraList');
            container.innerHTML = '';
            
            if (cameraList.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No saved cameras</p>';
                return;
            }
            
            cameraList.forEach((camera, index) => {
                const div = document.createElement('div');
                div.className = `camera-item ${camera.ip === currentCameraIP ? 'active' : ''}`;
                div.innerHTML = `
                    <div>
                        <strong>${camera.name || 'Camera'}</strong>
                        <div style="font-size: 12px; color: #666;">${camera.ip}</div>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="connectToSavedCamera('${camera.ip}')" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-plug"></i>
                        </button>
                        <button onclick="removeCamera(${index})" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Thêm camera hiện tại vào danh sách
        function addCurrentCamera() {
            if (!currentCameraIP) {
                showToast('No camera to add', 'warning');
                return;
            }
            
            const name = prompt('Enter camera name:', `Camera ${cameraList.length + 1}`);
            if (!name) return;
            
            // Kiểm tra trùng
            const exists = cameraList.find(cam => cam.ip === currentCameraIP);
            if (exists) {
                exists.name = name;
            } else {
                cameraList.push({
                    ip: currentCameraIP,
                    name: name,
                    added: Date.now()
                });
            }
            
            localStorage.setItem('esp32cam_saved', JSON.stringify(cameraList));
            renderCameraList();
            showToast('Camera saved', 'success');
        }
        
        // Xóa camera
        function removeCamera(index) {
            if (confirm('Remove this camera?')) {
                cameraList.splice(index, 1);
                localStorage.setItem('esp32cam_saved', JSON.stringify(cameraList));
                renderCameraList();
                showToast('Camera removed', 'info');
            }
        }
        
        // Kết nối đến camera đã lưu
        function connectToSavedCamera(ip) {
            document.getElementById('cameraIp').value = ip;
            connectToCamera();
        }
        
        // Quét mạng tìm camera
        function scanForCameras() {
            showToast('Scanning network...', 'info');
            // Implementation would go here
        }
        
        // Cập nhật chất lượng
        function updateQuality() {
            const value = document.getElementById('qualitySlider').value;
            let qualityText = 'Low';
            if (value > 40) qualityText = 'High';
            else if (value > 20) qualityText = 'Medium';
            
            document.getElementById('qualityValue').textContent = qualityText;
        }
        
        // Cập nhật độ sáng
        function updateBrightness() {
            const value = document.getElementById('brightnessSlider').value;
            document.getElementById('brightnessValue').textContent = value;
        }
        
        // Áp dụng cài đặt
        function applySettings() {
            if (!currentCameraIP) return;
            
            const quality = document.getElementById('qualitySlider').value;
            const framesize = document.getElementById('frameSizeSelect').value;
            
            fetch(`http://${currentCameraIP}/control?quality=${quality}&framesize=${framesize}`)
                .then(() => showToast('Settings applied', 'success'))
                .catch(err => showToast('Failed to apply settings', 'error'));
        }
        
        // Cập nhật trạng thái camera
        function updateCameraStatus() {
            if (!currentCameraIP) return;
            
            fetch(`http://${currentCameraIP}/status`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('statHeap').textContent = data.free_heap || '-';
                    document.getElementById('resolutionBadge').textContent = getResolutionText(data.framesize);
                })
                .catch(() => {
                    // Silent fail
                });
        }
        
        // Helper: Chuyển framesize thành text
        function getResolutionText(framesize) {
            const resolutions = {
                5: 'FRAMESIZE_QQVGA',
                6: 'FRAMESIZE_QCIF',
                7: 'FRAMESIZE_QVGA',
                8: 'FRAMESIZE_CIF',
                9: 'FRAMESIZE_VGA',
                10: 'FRAMESIZE_SVGA',
                11: 'FRAMESIZE_XGA',
                12: 'FRAMESIZE_SXGA'
            };
            return resolutions[framesize] || 'Unknown';
        }
        
        // Khởi động lại camera
        function rebootCamera() {
            if (!currentCameraIP) return;
            
            if (confirm('Reboot ESP32-CAM?')) {
                fetch(`http://${currentCameraIP}/reboot`)
                    .then(() => {
                        showToast('Camera rebooting...', 'warning');
                        setTimeout(() => {
                            startStream();
                        }, 10000);
                    })
                    .catch(err => showToast('Reboot failed', 'error'));
            }
        }
        
        // Reset settings
        function resetSettings() {
            if (confirm('Reset all settings?')) {
                localStorage.clear();
                location.reload();
            }
        }
        
        // Hiển thị QR code
        function showQR() {
            if (!currentCameraIP) return;
            
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=http://${currentCameraIP}`;
            const qrWindow = window.open(qrUrl, 'QR Code', 'width=300,height=300');
        }
        
        // Chia sẻ camera
        function shareCamera() {
            if (!currentCameraIP) return;
            
            const shareUrl = `${window.location.origin}?camera=${currentCameraIP}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'ESP32-CAM Stream',
                    text: 'Check out my ESP32-CAM live stream',
                    url: shareUrl
                });
            } else {
                navigator.clipboard.writeText(shareUrl);
                showToast('Link copied to clipboard', 'success');
            }
        }
        
        // Tải screenshot
        function downloadScreenshot() {
            const img = document.getElementById('screenshotPreview');
            const link = document.createElement('a');
            link.href = img.src;
            link.download = `esp32-screenshot-${Date.now()}.jpg`;
            link.click();
        }
        
        // Đóng screenshot modal
        function closeScreenshot() {
            document.getElementById('screenshotModal').style.display = 'none';
        }
        
        // Hiển thị toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.style.background = type === 'error' ? '#f44336' : 
                                   type === 'success' ? '#4CAF50' : 
                                   type === 'warning' ? '#ff9800' : '#2196F3';
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Cập nhật danh sách camera
        function updateCameraList(ip) {
            const exists = cameraList.find(cam => cam.ip === ip);
            if (!exists) {
                cameraList.unshift({
                    ip: ip,
                    name: `Camera ${cameraList.length + 1}`,
                    added: Date.now()
                });
                
                if (cameraList.length > 10) {
                    cameraList.pop();
                }
                
                localStorage.setItem('esp32cam_saved', JSON.stringify(cameraList));
                renderCameraList();
            }
        }
    </script>
</body>
</html>

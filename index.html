<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·ªìng H·ªì Th√¥ng Minh - ƒêi·ªÅu Khi·ªÉn ESP32</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üïí</text></svg>">
    <style>
        :root {
            --primary: #4CAF50;
            --primary-dark: #388E3C;
            --secondary: #2196F3;
            --danger: #f44336;
            --warning: #ff9800;
            --dark: #333;
            --light: #f5f5f5;
            --gray: #757575;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .connection-status {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .connected { color: #4CAF50; }
        .disconnected { color: #f44336; }
        
        .main-content {
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .card-title {
            color: var(--dark);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--primary);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 500;
            font-size: 14px;
        }
        
        .time-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        
        .time-input {
            width: 80px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            transition: border-color 0.3s;
        }
        
        .time-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .time-separator {
            font-size: 24px;
            font-weight: bold;
            color: var(--dark);
        }
        
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #1976D2 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #d32f2f 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #f57c00 100%);
            color: white;
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
            color: white;
        }
        
        .quick-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .quick-btn {
            padding: 15px;
            font-size: 14px;
        }
        
        .status-indicator {
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            margin: 15px 0;
            transition: all 0.3s;
        }
        
        .status-on {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 1px solid #b1dfbb;
        }
        
        .status-off {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 1px solid #f1b0b7;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }
        
        .info-item strong {
            display: block;
            color: var(--dark);
            margin-bottom: 5px;
            font-size: 13px;
        }
        
        .info-item span {
            color: var(--gray);
            font-size: 14px;
            font-weight: 500;
        }
        
        .sleep-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid var(--secondary);
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
            color: #0c5460;
        }
        
        .qr-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px dashed var(--primary);
            text-align: center;
        }
        
        #qrCode {
            width: 200px;
            height: 200px;
            margin: 15px auto;
            display: none;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.4s;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .install-prompt {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
            z-index: 999;
            font-size: 24px;
            transition: all 0.3s;
            display: none;
        }
        
        .install-prompt:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 35px rgba(76, 175, 80, 0.4);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            border: 1px solid #f1b0b7;
        }
        
        @media (max-width: 480px) {
            .container {
                border-radius: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .quick-controls {
                grid-template-columns: 1fr;
            }
            
            .time-input {
                width: 70px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-clock"></i> ƒê·ªìng H·ªì Th√¥ng Minh</h1>
            <p>ƒêi·ªÅu khi·ªÉn ESP32 t·ª´ xa qua Web Interface</p>
            <div class="connection-status">
                <i class="fas fa-wifi" id="wifiStatusIcon"></i>
                <span id="wifiStatusText">ƒêang k·∫øt n·ªëi...</span>
            </div>
        </div>
        
        <div class="main-content" id="mainContent">
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                <p>ƒêang k·∫øt n·ªëi ƒë·∫øn ESP32...</p>
            </div>
        </div>
    </div>
    
    <div class="install-prompt" id="installBtn" title="C√†i ƒë·∫∑t ·ª©ng d·ª•ng">
        <i class="fas fa-download"></i>
    </div>

    <script>
        // ========== BI·∫æN TO√ÄN C·ª§C ==========
        let espData = {
            ipAddress: "",
            alarmHour: 12,
            alarmMinute: 0,
            alarmEnabled: false,
            temperature: 25.0,
            humidity: 60.0,
            currentAlarmSound: 0,
            soundNames: ["Beep", "Melody 1", "Melody 2"]
        };
        
        let espIP = "";
        let isConnected = false;
        let connectionRetries = 0;
        const maxRetries = 5;
        
        // ========== H√ÄM HI·ªÇN TH·ªä GIAO DI·ªÜN ==========
        function renderLockedScreen() {
            return `
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-lock"></i> Kh√≥a B·∫£o M·∫≠t
                    </div>
                    <div class="form-group">
                        <p style="text-align: center; margin-bottom: 20px; color: #666;">
                            Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ truy c·∫≠p giao di·ªán ƒëi·ªÅu khi·ªÉn
                        </p>
                        <input type="password" id="passwordInput" class="time-input" placeholder="M·∫≠t kh·∫©u" style="width: 100%;">
                        <div class="button-group" style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="unlockInterface()">
                                <i class="fas fa-unlock"></i> M·ªü Kh√≥a
                            </button>
                        </div>
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <strong>ƒê·ªãa ch·ªâ IP:</strong>
                            <span id="deviceIp">${espData.ipAddress || "Ch∆∞a x√°c ƒë·ªãnh"}</span>
                        </div>
                        <div class="info-item">
                            <strong>Tr·∫°ng th√°i WiFi:</strong>
                            <span id="wifiInfo">ƒêang k·∫øt n·ªëi...</span>
                        </div>
                    </div>
                    <div class="sleep-info">
                        <i class="fas fa-mobile-alt"></i> <strong>Truy c·∫≠p Mobile:</strong> 
                        Scan QR code t·∫°i <a href="#" onclick="showQRCode(); return false;">ƒë√¢y</a>
                    </div>
                </div>
                
                <div class="qr-section" id="qrSection" style="display: none;">
                    <h3><i class="fas fa-qrcode"></i> QR Code Truy C·∫≠p</h3>
                    <img id="qrCodeImg" src="" alt="QR Code" style="display: none;">
                    <p style="margin: 10px 0; font-size: 14px; color: #666;">
                        M·ªü camera ƒëi·ªán tho·∫°i v√† scan QR code ƒë·ªÉ truy c·∫≠p
                    </p>
                    <button class="btn btn-secondary" onclick="hideQRCode()">
                        <i class="fas fa-times"></i> ƒê√≥ng
                    </button>
                </div>
            `;
        }
        
        function renderMainScreen() {
            return `
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-bell"></i> C√†i ƒê·∫∑t B√°o Th·ª©c
                    </div>
                    
                    <div class="form-group">
                        <label>Th·ªùi gian b√°o th·ª©c:</label>
                        <div class="time-input-group">
                            <input type="number" id="alarmHour" class="time-input" min="0" max="23" 
                                   value="${espData.alarmHour}" placeholder="HH">
                            <span class="time-separator">:</span>
                            <input type="number" id="alarmMinute" class="time-input" min="0" max="59" 
                                   value="${espData.alarmMinute}" placeholder="MM">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>√Çm thanh b√°o th·ª©c:</label>
                        <select id="alarmSound">
                            ${espData.soundNames.map((name, index) => `
                                <option value="${index}" ${index === espData.currentAlarmSound ? 'selected' : ''}>
                                    ${name}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="setAlarm(true)">
                            <i class="fas fa-play-circle"></i> B·∫¨T
                        </button>
                        <button class="btn btn-danger" onclick="setAlarm(false)">
                            <i class="fas fa-stop-circle"></i> T·∫ÆT
                        </button>
                    </div>
                    
                    <div id="alarmStatus" class="status-indicator ${espData.alarmEnabled ? 'status-on' : 'status-off'}">
                        <i class="fas ${espData.alarmEnabled ? 'fa-bell' : 'fa-bell-slash'}"></i>
                        ${espData.alarmEnabled ? 'B√ÅO TH·ª®C ƒêANG B·∫¨T' : 'B√ÅO TH·ª®C ƒêANG T·∫ÆT'}
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-gamepad"></i> ƒêi·ªÅu Khi·ªÉn Nhanh
                    </div>
                    
                    <div class="quick-controls">
                        <button class="btn quick-btn btn-primary" onclick="sendButtonCommand(1)">
                            <i class="fas fa-check-circle"></i> N√öT 1<br>
                            <small>Ch·ªçn/Enter</small>
                        </button>
                        <button class="btn quick-btn btn-secondary" onclick="sendButtonCommand(2)">
                            <i class="fas fa-arrow-up"></i> N√öT 2<br>
                            <small>TƒÉng gi√° tr·ªã</small>
                        </button>
                        <button class="btn quick-btn btn-warning" onclick="sendButtonCommand(3)">
                            <i class="fas fa-arrow-down"></i> N√öT 3<br>
                            <small>Gi·∫£m gi√° tr·ªã</small>
                        </button>
                        <button class="btn quick-btn btn-purple" onclick="snoozeAlarm()">
                            <i class="fas fa-pause-circle"></i> T·∫ÆT CHU√îNG<br>
                            <small>Snooze Alarm</small>
                        </button>
                    </div>
                    
                    <div class="button-group" style="margin-top: 15px;">
                        <button class="btn btn-danger" onclick="resetSystem()">
                            <i class="fas fa-redo"></i> KH·ªûI ƒê·ªòNG L·∫†I
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-chart-line"></i> Th√¥ng Tin H·ªá Th·ªëng
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <strong><i class="fas fa-network-wired"></i> ƒê·ªãa ch·ªâ IP:</strong>
                            <span id="displayIp">${espData.ipAddress}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-thermometer-half"></i> Nhi·ªát ƒë·ªô:</strong>
                            <span id="temperatureDisplay">${espData.temperature}¬∞C</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-tint"></i> ƒê·ªô ·∫©m:</strong>
                            <span id="humidityDisplay">${espData.humidity}%</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-clock"></i> Th·ªùi gian:</strong>
                            <span id="currentTime">${getCurrentTime()}</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-battery-three-quarters"></i> Uptime:</strong>
                            <span id="uptimeDisplay">0 ph√∫t</span>
                        </div>
                        <div class="info-item">
                            <strong><i class="fas fa-signal"></i> T√≠n hi·ªáu WiFi:</strong>
                            <span id="wifiSignal">- dBm</span>
                        </div>
                    </div>
                    
                    <div class="sleep-info">
                        <i class="fas fa-power-off"></i> <strong>Ch·∫ø ƒë·ªô ti·∫øt ki·ªám ƒëi·ªán:</strong> 
                        H·ªá th·ªëng t·ª± ƒë·ªông ng·ªß sau 30 ph√∫t kh√¥ng ho·∫°t ƒë·ªông
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-qrcode"></i> Truy C·∫≠p Nhanh
                    </div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="showQRCode()">
                            <i class="fas fa-qrcode"></i> Hi·ªÉn Th·ªã QR Code
                        </button>
                        <button class="btn btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> L√†m M·ªõi D·ªØ Li·ªáu
                        </button>
                    </div>
                    
                    <div class="qr-section" id="mainQRSection" style="display: none; margin-top: 15px;">
                        <h4><i class="fas fa-mobile-alt"></i> Scan ƒë·ªÉ c√†i ƒë·∫∑t ·ª©ng d·ª•ng</h4>
                        <img id="mainQRCode" src="" alt="QR Code" style="width: 150px; height: 150px; margin: 10px auto; display: none;">
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            M·ªü camera ƒëi·ªán tho·∫°i v√† scan QR code ƒë·ªÉ c√†i ƒë·∫∑t ·ª©ng d·ª•ng
                        </p>
                    </div>
                </div>
            `;
        }
        
        function renderErrorScreen(message) {
            return `
                <div class="error-message">
                    <h3><i class="fas fa-exclamation-triangle"></i> L·ªói K·∫øt N·ªëi</h3>
                    <p>${message}</p>
                    <div class="button-group" style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="connectToESP()">
                            <i class="fas fa-redo"></i> Th·ª≠ L·∫°i
                        </button>
                        <button class="btn btn-secondary" onclick="enterManualIP()">
                            <i class="fas fa-edit"></i> Nh·∫≠p IP Th·ªß C√¥ng
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-question-circle"></i> H∆∞·ªõng D·∫´n Kh·∫Øc Ph·ª•c
                    </div>
                    <div style="font-size: 14px; line-height: 1.6;">
                        <p><strong>1. Ki·ªÉm tra ESP32:</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 10px;">
                            <li>ƒê·∫£m b·∫£o ESP32 ƒë√£ ƒë∆∞·ª£c b·∫≠t</li>
                            <li>Ki·ªÉm tra ƒë√®n b√°o tr√™n ESP32</li>
                            <li>Xem Serial Monitor ƒë·ªÉ ki·ªÉm tra IP</li>
                        </ul>
                        
                        <p><strong>2. Ki·ªÉm tra m·∫°ng WiFi:</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 10px;">
                            <li>ƒê·∫£m b·∫£o c√πng m·∫°ng WiFi v·ªõi ESP32</li>
                            <li>Th·ª≠ reset l·∫°i router WiFi</li>
                            <li>Ki·ªÉm tra firewall/antivirus</li>
                        </ul>
                        
                        <p><strong>3. Ki·ªÉm tra IP:</strong></p>
                        <ul style="margin-left: 20px;">
                            <li>IP th∆∞·ªùng c√≥ d·∫°ng: 192.168.x.x</li>
                            <li>Ki·ªÉm tra trong router admin page</li>
                            <li>D√πng app network scanner</li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        // ========== H√ÄM X·ª¨ L√ù K·∫æT N·ªêI ==========
        async function connectToESP() {
            showLoading(true);
            
            try {
                // L·∫•y IP t·ª´ localStorage ho·∫∑c d√πng auto-discovery
                espIP = localStorage.getItem('esp_ip') || await discoverESP();
                
                if (!espIP) {
                    throw new Error("Kh√¥ng t√¨m th·∫•y ESP32 trong m·∫°ng");
                }
                
                // Test k·∫øt n·ªëi
                const response = await fetch(`http://${espIP}/`, { 
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                
                isConnected = true;
                connectionRetries = 0;
                updateConnectionStatus(true);
                
                // L·∫•y d·ªØ li·ªáu ban ƒë·∫ßu
                await fetchInitialData();
                
                // Hi·ªÉn th·ªã giao di·ªán ch√≠nh
                showMainInterface();
                
            } catch (error) {
                console.error("Connection error:", error);
                connectionRetries++;
                
                if (connectionRetries >= maxRetries) {
                    showError(`Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn ESP32<br>ƒê·ªãa ch·ªâ th·ª≠: ${espIP || 'Kh√¥ng x√°c ƒë·ªãnh'}`);
                } else {
                    // Th·ª≠ l·∫°i sau 2 gi√¢y
                    setTimeout(connectToESP, 2000);
                }
            }
        }
        
        async function discoverESP() {
            // Th·ª≠ c√°c IP ph·ªï bi·∫øn
            const commonIPs = [
                "192.168.1.100", "192.168.1.150", "192.168.1.200",
                "192.168.0.100", "192.168.0.150", "192.168.0.200",
                "192.168.4.1", "192.168.1.1", "192.168.0.1"
            ];
            
            for (const ip of commonIPs) {
                try {
                    const response = await fetch(`http://${ip}/`, { 
                        mode: 'no-cors',
                        cache: 'no-cache',
                        timeout: 1000 
                    });
                    
                    // N·∫øu c√≥ response (kh√¥ng b·ªã CORS error), ƒë√¢y c√≥ th·ªÉ l√† ESP
                    showToast(`T√¨m th·∫•y ESP32 t·∫°i: ${ip}`);
                    localStorage.setItem('esp_ip', ip);
                    return ip;
                } catch (e) {
                    continue;
                }
            }
            
            return null;
        }
        
        async function fetchInitialData() {
            try {
                // L·∫•y d·ªØ li·ªáu th√¥ng qua c√°c endpoint
                const endpoints = [
                    'getAlarmStatus',
                    'getSensors',
                    'getSystemInfo'
                ];
                
                for (const endpoint of endpoints) {
                    try {
                        await fetch(`http://${espIP}/${endpoint}`);
                    } catch (e) {
                        // B·ªè qua l·ªói t·ª´ c√°c endpoint kh√¥ng t·ªìn t·∫°i
                    }
                }
                
                // C·∫≠p nh·∫≠t th·ªùi gian hi·ªán t·∫°i
                updateCurrentTime();
                
            } catch (error) {
                console.error("Error fetching initial data:", error);
            }
        }
        
        // ========== H√ÄM G·ª¨I L·ªÜNH ==========
        async function sendCommand(command, data = {}) {
            if (!isConnected || !espIP) {
                showToast("Ch∆∞a k·∫øt n·ªëi ƒë·∫øn ESP32!");
                return false;
            }
            
            try {
                const params = new URLSearchParams(data);
                const url = `http://${espIP}/${command}?${params}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    mode: 'no-cors',
                    cache: 'no-cache'
                });
                
                showToast("L·ªánh ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!");
                return true;
                
            } catch (error) {
                console.error("Command error:", error);
                showToast("L·ªói khi g·ª≠i l·ªánh!");
                return false;
            }
        }
        
        function setAlarm(enable) {
            const hour = document.getElementById('alarmHour').value;
            const minute = document.getElementById('alarmMinute').value;
            const sound = document.getElementById('alarmSound').value;
            
            espData.alarmHour = hour;
            espData.alarmMinute = minute;
            espData.currentAlarmSound = sound;
            espData.alarmEnabled = enable;
            
            // C·∫≠p nh·∫≠t giao di·ªán ngay l·∫≠p t·ª©c
            updateAlarmStatus();
            
            // G·ª≠i l·ªánh ƒë·∫øn ESP
            sendCommand('setAlarmDirect', {
                hour: hour,
                minute: minute,
                sound: sound,
                enable: enable ? 1 : 0
            });
        }
        
        function sendButtonCommand(button) {
            sendCommand('button', { btn: button });
        }
        
        function snoozeAlarm() {
            sendCommand('snooze', {});
            showToast("ƒê√£ t·∫Øt b√°o th·ª©c t·∫°m th·ªùi");
        }
        
        function resetSystem() {
            if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën kh·ªüi ƒë·ªông l·∫°i h·ªá th·ªëng?")) {
                sendCommand('reset', {});
                showToast("H·ªá th·ªëng ƒëang kh·ªüi ƒë·ªông l·∫°i...");
                
                // T·ª± ƒë·ªông reconnect sau 5 gi√¢y
                setTimeout(() => {
                    location.reload();
                }, 5000);
            }
        }
        
        function resetSleepTimer() {
            sendCommand('resetSleepTimer', {});
        }
        
        // ========== H√ÄM HI·ªÇN TH·ªä ==========
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showMainInterface() {
            document.getElementById('mainContent').innerHTML = renderMainScreen();
            startDataUpdates();
        }
        
        function showError(message) {
            document.getElementById('mainContent').innerHTML = renderErrorScreen(message);
            updateConnectionStatus(false);
        }
        
        function updateConnectionStatus(connected) {
            const icon = document.getElementById('wifiStatusIcon');
            const text = document.getElementById('wifiStatusText');
            
            if (connected) {
                icon.className = 'fas fa-wifi connected';
                text.textContent = 'ƒê√£ k·∫øt n·ªëi';
                text.className = 'connected';
            } else {
                icon.className = 'fas fa-wifi-slash disconnected';
                text.textContent = 'M·∫•t k·∫øt n·ªëi';
                text.className = 'disconnected';
            }
        }
        
        function updateAlarmStatus() {
            const statusElement = document.getElementById('alarmStatus');
            if (statusElement) {
                statusElement.className = `status-indicator ${espData.alarmEnabled ? 'status-on' : 'status-off'}`;
                statusElement.innerHTML = `
                    <i class="fas ${espData.alarmEnabled ? 'fa-bell' : 'fa-bell-slash'}"></i>
                    ${espData.alarmEnabled ? 'B√ÅO TH·ª®C ƒêANG B·∫¨T' : 'B√ÅO TH·ª®C ƒêANG T·∫ÆT'}
                `;
            }
        }
        
        function updateCurrentTime() {
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = getCurrentTime();
            }
        }
        
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('vi-VN');
        }
        
        function showQRCode() {
            const ip = espData.ipAddress || espIP || window.location.hostname;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=http://${ip}`;
            
            // Hi·ªÉn th·ªã QR trong c·∫£ hai section
            const qrImg = document.getElementById('qrCodeImg');
            const mainQR = document.getElementById('mainQRCode');
            
            if (qrImg) {
                qrImg.src = qrUrl;
                qrImg.style.display = 'block';
                document.getElementById('qrSection').style.display = 'block';
            }
            
            if (mainQR) {
                mainQR.src = qrUrl;
                mainQR.style.display = 'block';
                document.getElementById('mainQRSection').style.display = 'block';
            }
        }
        
        function hideQRCode() {
            const qrSection = document.getElementById('qrSection');
            if (qrSection) qrSection.style.display = 'none';
            
            const mainQRSection = document.getElementById('mainQRSection');
            if (mainQRSection) mainQRSection.style.display = 'none';
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Hi·ªÉn th·ªã toast
            setTimeout(() => toast.classList.add('show'), 10);
            
            // ·∫®n toast sau 3 gi√¢y
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 400);
            }, 3000);
        }
        
        function unlockInterface() {
            const password = document.getElementById('passwordInput').value;
            
            if (password === '123456') {
                // L∆∞u tr·∫°ng th√°i unlocked
                localStorage.setItem('unlocked', 'true');
                
                // Hi·ªÉn th·ªã giao di·ªán ch√≠nh
                showMainInterface();
                showToast("M·ªü kh√≥a th√†nh c√¥ng!");
            } else {
                showToast("M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!");
            }
        }
        
        function enterManualIP() {
            const ip = prompt("Nh·∫≠p ƒë·ªãa ch·ªâ IP c·ªßa ESP32 (v√≠ d·ª•: 192.168.1.100):");
            if (ip) {
                localStorage.setItem('esp_ip', ip);
                espIP = ip;
                connectToESP();
            }
        }
        
        function refreshData() {
            showToast("ƒêang l√†m m·ªõi d·ªØ li·ªáu...");
            fetchInitialData();
        }
        
        // ========== AUTO-UPDATE DATA ==========
        function startDataUpdates() {
            // C·∫≠p nh·∫≠t th·ªùi gian m·ªói gi√¢y
            setInterval(updateCurrentTime, 1000);
            
            // C·∫≠p nh·∫≠t uptime m·ªói ph√∫t
            setInterval(() => {
                const uptimeElement = document.getElementById('uptimeDisplay');
                if (uptimeElement) {
                    const currentUptime = uptimeElement.textContent;
                    const minutes = parseInt(currentUptime) || 0;
                    uptimeElement.textContent = (minutes + 1) + ' ph√∫t';
                }
            }, 60000);
            
            // Reset sleep timer khi c√≥ t∆∞∆°ng t√°c
            document.addEventListener('click', resetSleepTimer);
            document.addEventListener('touchstart', resetSleepTimer);
            document.addEventListener('keypress', resetSleepTimer);
        }
        
        // ========== PWA INSTALLATION ==========
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'flex';
        });
        
        document.getElementById('installBtn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    showToast("·ª®ng d·ª•ng ƒë√£ ƒë∆∞·ª£c c√†i ƒë·∫∑t!");
                }
                
                deferredPrompt = null;
                document.getElementById('installBtn').style.display = 'none';
            }
        });
        
        // ========== KH·ªûI ƒê·ªòNG ·ª®NG D·ª§NG ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Ki·ªÉm tra tr·∫°ng th√°i unlocked
            const isUnlocked = localStorage.getItem('unlocked') === 'true';
            
            if (isUnlocked) {
                // T·ª± ƒë·ªông k·∫øt n·ªëi
                connectToESP();
            } else {
                // Hi·ªÉn th·ªã m√†n h√¨nh locked
                document.getElementById('mainContent').innerHTML = renderLockedScreen();
                showLoading(false);
                
                // V·∫´n th·ª≠ k·∫øt n·ªëi ƒë·ªÉ l·∫•y IP
                connectToESP();
            }
            
            // Service Worker cho PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            }
        });
        
        // Handle online/offline events
        window.addEventListener('online', () => {
            showToast("ƒê√£ k·∫øt n·ªëi l·∫°i internet!");
            connectToESP();
        });
        
        window.addEventListener('offline', () => {
            showToast("M·∫•t k·∫øt n·ªëi internet!");
            updateConnectionStatus(false);
        });
        
        // Auto-reconnect every 30 seconds if disconnected
        setInterval(() => {
            if (!isConnected && navigator.onLine) {
                connectToESP();
            }
        }, 30000);
    </script>
</body>
</html>
